<!DOCTYPE html>
<html lang="en">
<head>
  <title>Sort, sweep, and prune: collision detection algorithms ¬∑ leanrada.com</title>
  <script async="" src="/lib/vendor/perlin-noise-3d.min.js"></script>
  <script type="module" client="" defer="">
    import {
      waitFor
    } from "/lib/wait_for.mjs";
    import {
      BaseElement
    } from "/lib/base_element.mjs";
    import {
      mousePosition
    } from "/lib/mouse_position.mjs";

    customElements.define(
      "nebula-client",
      class Nebula extends BaseElement {
        constructor() {
          super();

          this.asyncCanvas = this.asyncQuerySelector("canvas");
          this.context = null;
          this.noise = null;

          this.gridWidth = 30;
          this.gridHeight = 30;
          this.palette = ["#ffffff"];

          this.cellWidth = 1; // placeholder
          this.cellHeight = 1; // placeholder

          this.useMouse = false;
          this.mouseCell = null;

          this.lastT = 0;
          this.startT = 0;
          this.loopStartT = 0;

          this.isVisible = false;
          this.visibilityListener({
            show: () => {
              this.isVisible = true;
              this.startLoop();
            },
            hide: () => (this.isVisible = false),
          });
        }

        connectedCallback() {
          super.connectedCallback();

          this.useMouse = this.getAttribute("mouse") != null;

          const gridWidth = this.getAttribute("width");
          if (gridWidth) {
            this.gridWidth = Number.parseInt(gridWidth);
          }

          const gridHeight = this.getAttribute("height");
          if (gridHeight) {
            this.gridHeight = Number.parseInt(gridHeight);
          }

          const paletteAttr = this.getAttribute("palette");
          if (paletteAttr) {
            this.palette = paletteAttr.split(" ");
          }
        }

        startLoop() {
          this.loopStartT = this.lastT = this.getT();
          this.loop();
        }

        async loop() {
          if (!this.isVisible) {
            return;
          }

          if (typeof perlinNoise3d === "undefined") {
            await waitFor(() => typeof perlinNoise3d !== "undefined");
          }

          if (!this.noise) {
            this.noise = initNoise();
            this.startT = this.getT();
          }

          const canvas = await this.asyncCanvas.promise;

          // initialize
          if (!this.context) {
            this.cellWidth = Math.ceil(canvas.offsetWidth / this.gridWidth);
            this.cellHeight = Math.ceil(canvas.offsetHeight / this.gridHeight);
            canvas.width = this.gridWidth;
            canvas.height = this.gridHeight;
            canvas.style.filter += ` blur(${
            Math.min(this.cellWidth, this.cellHeight) * 1.25
          }px)`;
            this.context = canvas.getContext("2d");
          }

          this.draw(canvas, this.context);

          requestAnimationFrame(() => this.loop());
        }

        /**
         * @param canvas {HTMLCanvasElement}
         * @param context {CanvasRenderingContext2D}
         */
        draw(canvas, context) {
          const t = this.getT();
          if (t <= this.lastT) return;

          const alpha = 1 - Math.pow(1 - 0.016, t - this.lastT);
          this.lastT = t;

          const {
            noise,
            gridWidth,
            gridHeight,
            palette,
            cellWidth,
            cellHeight
          } =
          this;
          const halfGridWidth = gridWidth / 2;
          const halfGridHeight = gridHeight / 2;

          this.mouseCell = null;
          if (this.useMouse) {
            const {
              x,
              y
            } = mousePosition;
            const bounds = canvas.getBoundingClientRect();
            if (
              bounds.left < x &&
              x < bounds.right &&
              bounds.top < y &&
              y < bounds.bottom
            ) {
              this.mouseCell = {
                x: (x - bounds.x) / cellWidth,
                y: (y - bounds.y) / cellHeight,
              };
            }
          }

          const paletteLength = palette.length;
          const xScale = 0.14 + Math.sin(t * 0.03) * 0.06;
          const yScale = 0.14 + Math.cos(t * 0.05) * 0.06;

          for (let i = 0; i < gridWidth; i++) {
            for (let j = 0; j < gridHeight; j++) {
              const mouseProximity =
                this.mouseCell == null ?
                0 :
                1 -
                sigmoid(
                  Math.hypot(i - this.mouseCell.x, j - this.mouseCell.y) - 3
                );

              const xy = [
                1000 + (i - halfGridWidth) * xScale + Math.sin(t * 0.01) * 2,
                1000 +
                (j - halfGridHeight) * yScale +
                Math.cos(t * 0.007) * 2 +
                -mouseProximity,
              ];
              const p1 = noise.get(...xy, t * 0.03);
              const p2 = noise.get(...xy, t * 0.03 + 0.5);
              // for some reason, this library's output range is [0,0.5], so this averages to [0,1]
              const p = p1 + p2;

              const paletteIndex = Math.floor(paletteLength * p);

              const rgb = palette[paletteIndex];
              const a = Math.floor(Math.max(alpha, mouseProximity) * 255)
                .toString(16)
                .padStart(2, "0");

              context.fillStyle = `${rgb}${a}`;
              context.fillRect(i, j, 1, 1);
            }
          }
        }

        getT() {
          const t = (Date.now() * 24) / 1000;
          // make it smoother while interacting
          return this.mouseCell ? t : Math.floor(t);
        }
      }
    );

    function initNoise() {
      const noise = new perlinNoise3d();
      noise.perlin_octaves = 1; // ?? defaults
      noise.perlin_amp_falloff = 1;
      return noise;
    }

    function sigmoid(x) {
      return 1 / (1 + Math.exp(-x));
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/favicon.png">
  <script type="module" client="" defer="">
    import {
      BaseElement
    } from "/lib/base_element.mjs";
    // Warn: Module paths are relative to the page, not the component
    // Since this is used by two separate posts, we move up once to converge the paths
    import {
      BallSim
    } from "../sweep-and-prune/ball-sim/ball-sim.mjs";
    import {
      Runner
    } from "../sweep-and-prune/ball-sim/runner.mjs";
    import {
      Renderer
    } from "../sweep-and-prune/ball-sim/renderer.mjs";
    import {
      setupDragging
    } from "../sweep-and-prune/ball-sim/dragging.mjs";
    import {
      createProcessPhysicsFunc
    } from "../sweep-and-prune/ball-sim/process-physics.mjs";
    import {
      createDecorations
    } from "../sweep-and-prune/ball-sim/decorations/decorations.mjs";
    import {
      NoopStrat
    } from "../sweep-and-prune/ball-sim/collision-strats/noop-strat.mjs";
    import {
      PairwiseStrat
    } from "../sweep-and-prune/ball-sim/collision-strats/pairwise-strat.mjs";
    import {
      SimpleSweepAndPruneStrat
    } from "../sweep-and-prune/ball-sim/collision-strats/simple-sap-strat.mjs";
    import {
      SweepAndPruneStrat
    } from "../sweep-and-prune/ball-sim/collision-strats/sap-strat.mjs";
    import {
      SweepAndPruneSwapStrat
    } from "../sweep-and-prune/ball-sim/collision-strats/sap-swap-strat.mjs";
    import {
      SweepAndPruneSwap2DStrat
    } from "../sweep-and-prune/ball-sim/collision-strats/sap-swap-2d-strat.mjs";
    import {
      SkippingDelegateStrat
    } from "../sweep-and-prune/ball-sim/collision-strats/skip-delegate-strat.mjs";
    import {
      createQuickSort
    } from "../sweep-and-prune/ball-sim/sorts/quick-sort.mjs";
    import {
      createInsertionSort
    } from "../sweep-and-prune/ball-sim/sorts/insertion-sort.mjs";

    customElements.define(
      "sap-demo-client",
      class SweepAndPruneDemoClient extends BaseElement {
        constructor() {
          super();

          this.visibilityListener({
            show: async () => {
              if (!this.hasInit) this.init();
              this.runner.start();
            },
            hide: async () => {
              if (this.runner) this.runner.stop();
            },
          });
        }

        disconnectedCallback() {
          super.disconnectedCallback();
          this.cleanup();
        }

        init() {
          this.cleanup();

          const ballsAttr = this.getAttribute("balls");
          const strategyAttr = this.getAttribute("strategy");
          const isStatic = this.hasAttribute("static");
          const noBounce = this.hasAttribute("no-bounce");
          const isDraggable = this.hasAttribute("draggable");
          const labelsAttr = this.getAttribute("labels");
          const isRainbow = this.hasAttribute("rainbow");
          const decorationsAttr = this.getAttribute("decorations");
          const skipIntervalAttr = this.getAttribute("skip-interval");

          const ballSimCreator = BallSim.create(600, 400);
          if (ballsAttr?.startsWith("[")) {
            const ballsSpec = JSON.parse(ballsAttr);
            for (const [x, y, radius] of ballsSpec) {
              ballSimCreator.addBall(x, y, radius);
            }
          } else {
            const ballCount = ballsAttr?.match(/\d+/) ?
              Number.parseInt(ballsAttr) :
              5;
            ballSimCreator.addRandomBalls(ballCount, 0.06 + 0.2 / ballCount);
          }

          this.ballSim = ballSimCreator
            .setStatic(isStatic)
            .setEventTarget(this)
            .build();

          if (isRainbow) {
            const {
              balls
            } = this.ballSim;
            for (let i = 0; i < balls.length; i++) {
              const ball = balls[i];
              const h = i / balls.length;
              ball.color = `hsl(${h}turn 90% 70%)`;
            }
          }

          this.canvas = document.createElement("canvas");
          this.canvas.width = this.ballSim.width;
          this.canvas.height = this.ballSim.height;
          this.appendChild(this.canvas);

          const labelsValue = labelsAttr?.split(",") ?? [];
          this.renderer = new Renderer(
            this.ballSim,
            this.canvas,
            labelsValue,
            isDraggable
          );

          const pause = (duration) => this.runner.pause(duration);

          const {
            callbacks
          } = createDecorations(
            decorationsAttr,
            this.ballSim,
            this.renderer,
            pause
          );

          const processFunc = createProcessPhysicsFunc(
            !noBounce && !isStatic,
            callbacks
          );

          const collStrat = createCollisionStrategy(
            this.ballSim,
            this.renderer,
            processFunc,
            callbacks,
            this,
            strategyAttr,
            skipIntervalAttr
          );

          this.runner = new Runner(collStrat, this.ballSim, this.renderer);

          if (isDraggable) {
            setupDragging(this.ballSim, this.canvas, this);
          }

          this.hasInit = true;
        }

        cleanup() {
          this.replaceChildren();
          if (this.runner) this.runner.stop();
          this.canvas = undefined;
          this.renderer = undefined;
          this.ballSim = undefined;
          this.runner = undefined;
          this.hasInit = false;
        }
      }
    );

    function createCollisionStrategy(
      ballSim,
      renderer,
      processFunc,
      callbacks,
      eventTarget,
      strategyAttr,
      skipIntervalAttr
    ) {
      let collStrat;
      switch (strategyAttr) {
        case "noop":
          collStrat = new NoopStrat();
          break;
        case "pairwise":
          collStrat = new PairwiseStrat(ballSim, renderer, processFunc);
          break;
        case "simple-sap":
          collStrat = new SimpleSweepAndPruneStrat(
            ballSim,
            (arr) => arr.sort((a, b) => a.x - b.x),
            processFunc,
            callbacks,
            eventTarget
          );
          break;
        case "sap-nativesort":
          collStrat = new SweepAndPruneStrat(
            ballSim,
            (arr) => arr.sort((a, b) => a.x - b.x),
            processFunc,
            callbacks,
            eventTarget
          );
          break;
        case "sap-quicksort":
          collStrat = new SweepAndPruneStrat(
            ballSim,
            createQuickSort(callbacks),
            processFunc,
            callbacks
          );
          break;
        case "sap-insertionsort":
          collStrat = new SweepAndPruneStrat(
            ballSim,
            createInsertionSort(callbacks),
            processFunc,
            callbacks
          );
          break;
        case "sap-swap":
          collStrat = new SweepAndPruneSwapStrat(ballSim, processFunc, callbacks);
          break;
        case "sap-swap-2d":
          collStrat = new SweepAndPruneSwap2DStrat(
            ballSim,
            processFunc,
            callbacks
          );
          break;
        default:
          throw new Error("Invalid strategy: " + strategyAttr);
      }

      if (skipIntervalAttr) {
        collStrat = new SkippingDelegateStrat(
          Number.parseInt(skipIntervalAttr),
          collStrat
        );
      }

      return collStrat;
    }
  </script>
  <meta charset="utf-8">
  <link rel="webmention" href="https://webmention.io/leanrada.com/webmention">
  <script async="" src="https://cdn.jsdelivr.net/gh/Kalabasa/analytics/analytics.js"></script>
  <style>
    .box-note {
      display: block;
      padding: 12px 18px;
      border-radius: 12px;
      border: solid 2px var(--clr0-dark);
      box-sizing: border-box;
    }
  </style>
  <style>
    /**
   * Modified by Kalabasa.
   * Based on:
   * a11y-dark theme for JavaScript, CSS, and HTML
   * Based on the okaidia theme: https://github.com/PrismJS/prism/blob/gh-pages/hemes/prism-okaidia.css
   * @author ericwbailey
   */

    .code-block .token.inserted:not(.prefix) {
      background: #00b6a71c;
      display: block;
    }

    .code-block .token.comment,
    .code-block .token.prolog,
    .code-block .token.doctype,
    .code-block .token.cdata {
      color: #628b9e;
      font-style: italic;
    }

    .code-block .token.punctuation {
      color: #fefefe;
    }

    .code-block .token.property,
    .code-block .token.tag,
    .code-block .token.constant,
    .code-block .token.symbol,
    .code-block .token.deleted {
      color: #ffa07a;
    }

    .code-block .token.boolean,
    .code-block .token.number {
      color: #00e0e0;
    }

    .code-block .token.selector,
    .code-block .token.attr-name,
    .code-block .token.string,
    .code-block .token.char,
    .code-block .token.builtin,
    .code-block .token.inserted {
      color: #abe338;
    }

    .code-block .token.operator,
    .code-block .token.entity,
    .code-block .token.url,
    .code-block .token.variable {
      color: #00e0e0;
    }

    .code-block .token.atrule,
    .code-block .token.attr-value,
    .code-block .token.function {
      color: #ffd700;
    }

    .code-block .token.keyword {
      color: #00e0e0;
    }

    .code-block .token.regex,
    .code-block .token.important {
      color: #ffd700;
    }

    .code-block .token.important,
    .code-block .token.bold {
      font-weight: bold;
    }

    .code-block .token.italic {
      font-style: italic;
    }

    .code-block .token.entity {
      cursor: help;
    }

    @media screen and (-ms-high-contrast: active) {
      .code-block .token.important {
        background: highlight;
        color: window;
        font-weight: normal;
      }

      .code-block .token.atrule,
      .code-block .token.attr-value,
      .code-block .token.function,
      .code-block .token.keyword,
      .code-block .token.operator,
      .code-block .token.selector {
        font-weight: bold;
      }

      .code-block .token.attr-value,
      .code-block .token.comment,
      .code-block .token.doctype,
      .code-block .token.function,
      .code-block .token.keyword,
      .code-block .token.operator,
      .code-block .token.property,
      .code-block .token.string {
        color: highlight;
      }

      .code-block .token.attr-value,
      .code-block .token.url {
        font-weight: normal;
      }
    }
  </style>
  <style>
    .code-block {
      margin: 0 -18px;
      /* bleed content padding */
      padding: 0 18px;
      /* bleed content padding */
      overflow-x: auto;
    }

    .code-block-code {
      display: inline-block;
      padding: 18px;
      min-width: 100%;
      box-sizing: border-box;
      border-radius: 18px;
      font-family: var(--default-font, monospace);
      font-size: 15px;
      line-height: 1.6;
      background: var(--card-clr);
      white-space: pre;
    }
  </style>
  <style>
    sap-demo-client {
      display: flex;
    }

    sap-demo-client>canvas {
      width: 100%;
      border: solid 2px #ccc;
      border-radius: 12px;
    }

    .sap-demo-draggable>canvas {
      touch-action: none;
    }
  </style>
  <style>
    .text-link {
      color: var(--clr0-light, #fff);
    }

    .text-link:visited {
      color: var(--clr0, #fff);
    }
  </style>
  <style>
    .blog-media {
      position: relative;
      text-align: center;
      /* external margin because it‚Äôs expected to be in an article */
      margin: 36px 0;
    }

    .blog-media-bleed {
      margin: 90px 0;
      max-height: 80vh;
    }

    .blog-media-element {
      display: inline-block;
      max-width: 100%;
      max-height: 80vh;
      border-radius: 18px;
      box-sizing: border-box;
    }

    .blog-media-bleed .blog-media-element {
      position: relative;
      left: 50%;
      max-width: max(min(100vw, 800px), 80vw);
      transform: translateX(-50%);
    }

    .blog-media-windowed .blog-media-element {
      border-radius: 0;
    }

    .blog-media-caption {
      display: block;
      font-size: 15px;
    }
  </style>
  <style>
    .tag-component {
      display: inline-block;
      padding: 0 3px;
      height: 16px;
      line-height: 16px;
      font-family: var(--default-font);
      font-size: 12px;
      font-weight: bold;
      background: #ccc;
      color: #444;
      border-radius: 3px;
    }
  </style>
  <style>
    .tag-row {
      font-family: var(--default-font);
      font-size: 12px;
      font-weight: bold;
    }
  </style>
  <style>
    .blog-post-info {
      margin: 24px 0;
      font-family: var(--default-font);
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      color: var(--text2-clr);
    }

    .blog-post-info-hidden {
      display: none;
    }
  </style>
  <style>
    .text-with-bg-span {
      display: inline;
      margin: 0;
      padding: 0.7em;
      padding: 0.35lh;
      border-radius: 18px;
      box-decoration-break: clone;
      -webkit-box-decoration-break: clone;
      font: inherit;
      background: var(--text-with-bg-color);
    }
  </style>
  <style>
    .blog-header {
      isolation: isolate;
      margin: 90px 0 24px;
      position: relative;
      left: 50%;
      height: 600px;
      width: max(800px, 60vw);
      transform: translateX(-50%);
      box-sizing: border-box;
    }

    .blog-header-title {
      position: relative;
      max-width: 800px;
      font-family: var(--display-font);
      font-size: 36px;
      font-weight: bold;
      font-style: italic;
      text-align: left;
      z-index: 2;
    }

    .blog-header-title-inner {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    /* Wrap lines in an angle */
    .blog-header-title::before {
      content: "";
      width: 0;
      width: calc(min(50%, 120vw - 600px));
      height: 600px;
      float: right;
      shape-outside: polygon(100% 0%, 20% 30%, 0% 100%, 100% 100%, 100% 0%);
    }

    .blog-header-hero {
      position: absolute;
      inset: 1px;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 18px;
      background: gray;
      z-index: -1;
    }

    .blog-header-decor {
      position: absolute;
      inset: 0;
      pointer-events: none;
      fill: var(--bg-clr);
      z-index: 1;
    }

    @media (max-width: 800px) {
      .blog-header {
        width: 100vw;
        width: 100svw;
        height: 400px;
        padding-right: 36px;
      }

      .blog-header-title {
        font-size: clamp(24px, 20px + 2vw, 36px);
      }
    }
  </style>
  <style>
    @import "/fonts/iosevka.css";
    @import "/fonts/top.css";

    :root {
      --default-font: "Iosevka Fixed SS15 Web", "Space Mono", monaco, Consolas, "Lucida Console", monospace;
      --display-font: "Space Mono", "Iosevka Fixed SS15 Web", monaco, Consolas, "Lucida Console", monospace;
      --reading-font: "Miriam Libre", Futura, "Trebuchet MS", Arial, sans-serif;

      --bg-clr: #111616;
      --card-clr: #222c2c;
      --clr0-light: #54f8c1;
      --clr0: #0ad591;
      --clr0-dark: #05b97d;
      --clr1: #df2063;

      --text-clr: #fff;
      --text2-clr: #999;

      --ease: cubic-bezier(0.8, 0, 1, 1);
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--default-font, monospace);
      font-size: 15px;
      font-display: swap;
      font-variant-ligatures: none;
      background-color: var(--bg-clr, #111);
      color: var(--text-clr, #fff);
      overflow-x: hidden;
    }

    .page-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .page-wrapper-content {
      flex: 1 1 auto;
    }
  </style>
  <style>
    nebula-client {
      position: relative;
    }

    nebula-client>canvas {
      width: 100%;
      height: 100%;
    }

    .nebula-noise {
      position: absolute;
      inset: 0;
      background: url("/noise.png");
      /* todo: encapsulate noise.png */
      opacity: 0.1;
      animation: nebula-noise-x 0.16s steps(2, jump-start) infinite,
        nebula-noise-y 0.48s steps(3, jump-start) infinite;
    }

    @supports (mix-blend-mode: overlay) {
      .nebula-noise {
        mix-blend-mode: overlay;
        opacity: 0.2;
      }
    }

    @keyframes nebula-noise-x {
      to {
        background-position-x: 100px;
      }
    }

    @keyframes nebula-noise-y {
      to {
        background-position-y: 100px;
      }
    }
  </style>
  <style>
    .main-footer-web-link {
      text-decoration: none;
    }

    .main-footer-web-link-icon {
      width: 32px;
      height: 32px;
      image-rendering: pixelated;
    }

    .main-footer-web-link-icon:hover {
      filter: invert(1);
    }
  </style>
  <style>
    .main-footer {
      position: relative;
      display: flex;
      justify-content: space-between;
      gap: 60px;
      padding: 42px calc(max(36px, 50vw - 600px));
      font-family: var(--display-font);
      font-size: 15px;
      font-weight: bold;
      background: var(--clr0);
      color: #000;
      overflow: hidden;
      content-visibility: auto;
      contain-intrinsic-height: 200px;
    }

    .main-footer-links-heading {
      margin: 18px 0;
      font-size: inherit;
    }

    .main-footer-line {
      margin: 18px 0;
    }

    .main-footer-link {
      color: #000;
    }

    .main-footer-link:hover {
      color: #000;
    }

    .main-footer-webring-icon {
      width: 16px;
      height: 16px;
      image-rendering: pixelated;
    }

    .main-footer-signature {
      width: 64px;
      height: 64px;
      image-rendering: pixelated;
      vertical-align: middle;
    }

    .main-footer-content-part {
      z-index: 1;
    }

    .main-footer-nebula {
      position: absolute;
      left: -30%;
      top: -30%;
      width: 160%;
      height: 160%;
      z-index: 0;
    }

    .main-footer-top-btn {
      display: block;
      z-index: 2;
      position: absolute;
      right: 0;
      top: 0;
      width: 72px;
      height: 36px;
      padding-right: 9px;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
      border: none;
      border-bottom-left-radius: 18px;
      background: var(--bg-clr);
      text-decoration: none;
      color: var(--clr0-light);
      font: inherit;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
    }

    .main-footer-top-btn:hover {
      color: var(--clr1);
    }

    .main-footer-top-btn::before {
      content: "";
      position: absolute;
      right: 0;
      top: 0;
      width: 36px;
      height: 18px;
      border-top-right-radius: 18px;
      transform: translateX(-72px);
      box-shadow: 18px 0 0 var(--bg-clr);
    }

    @media (max-width: 700px) {
      .main-footer {
        flex-direction: column-reverse;
      }
    }
  </style>
  <style>
    .main-header {
      position: sticky;
      top: 0;
      width: 100%;
      height: 60px;
      padding: 0 calc(25% - 150px);
      z-index: 100;
      box-sizing: border-box;
      pointer-events: none;
    }

    .main-header.float {
      position: fixed;
    }

    .main-header-bar {
      position: relative;
      display: flex;
      justify-content: space-evenly;
      align-items: flex-end;
      height: 100%;
    }

    .main-header-item {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 6ch;
      height: 36px;
      padding: 0 18px;
      border-radius: 18px;
      font-family: var(--display-font);
      font-size: 15px;
      font-weight: bold;
      letter-spacing: 1px;
      text-decoration: none;
      text-transform: uppercase;
      color: #fff;
      backdrop-filter: blur(8px);
      background-image: linear-gradient(60deg, #fff2 60%, transparent 60%);
      background-repeat: no-repeat;
      background-size: 220% 100%;
      background-position: 115%;
      pointer-events: all;
      transition: background-position 0.2s var(--ease);
    }

    .main-header-item:hover {
      background-image: linear-gradient(60deg,
          #fff2 50%,
          #fff 50%,
          #fff 60%,
          transparent 60%);
      background-position: 0%;
    }

    .main-header-item.select {
      background: #fff2;
    }

    .main-header-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      image-rendering: pixelated;
      object-fit: cover;
      object-position: 0 0;
      filter: invert(1);
      backdrop-filter: blur(8px) invert(1);
      pointer-events: all;
    }

    .main-header-icon:hover {
      object-position: 100% 0;
    }

    @media (max-width: 450px) {
      .main-header-icon {
        display: none;
      }
    }

    .main-header-indicator {
      position: absolute;
      width: 6px;
      height: 6px;
      left: 50%;
      top: calc(100% + 12px);
      transform: translate(-50%, -50%);
      /* border acts as extended touch area */
      border: solid 6mm transparent;
      border-left-width: 45vw;
      border-right-width: 45vw;
      border-radius: 50%;
      background: #fff;
      background-clip: padding-box;
      opacity: 0;
      transition: opacity 50ms;
    }

    .main-header.hidden .main-header-indicator {
      opacity: 0.8;
      pointer-events: all;
    }
  </style>
  <style>
    .blog-page {
      margin: auto;
      overflow: hidden;
    }

    .content {
      margin: auto;
      padding: 0 18px 60px;
      width: 100%;
      max-width: 700px;
      font-family: var(--reading-font, sans-serif);
      font-size: 16px;
      line-height: 2.2;
      letter-spacing: 0.02em;
      color: #ddd;
      box-sizing: border-box;
    }

    .markdown>h1,
    .markdown>h2,
    .markdown>h3,
    .markdown>h4,
    .markdown>h5,
    .markdown>h6 {
      margin: 48px 0 36px;
      font-family: var(--display-font);
      font-weight: normal;
      font-style: italic;
      line-height: 1.6;
      letter-spacing: 0.04em;
      text-wrap: balance;
    }

    .markdown>h1 {
      text-align: center;
      font-size: 200%;
    }

    .markdown>h2 {
      font-size: 150%;
    }

    .markdown>h3,
    .markdown>h4,
    .markdown>h5,
    .markdown>h6 {
      font-size: 120%;
      font-weight: bold;
    }

    .markdown>p {
      margin: 36px 0;
    }

    .markdown .box-note>p {
      margin: 18px 0;
    }

    .markdown .box-note>p:first-child {
      margin-top: 0;
    }

    .markdown .box-note>p:last-child {
      margin-bottom: 0;
    }

    .markdown-table {
      margin: 0 -18px;
      /* bleed content padding */
      padding: 0 18px;
      /* bleed content padding */
      overflow-x: auto;
    }

    .markdown-table>table {
      min-width: 100%;
      box-sizing: border-box;
      border-collapse: collapse;
      background-color: var(--card-clr);
      border-radius: 12px;
    }

    .markdown-table>table th,
    .markdown-table>table td {
      min-width: min(25vw, 8ch);
      box-sizing: border-box;
      text-align: start;
      padding: 9px 6px;
      padding-inline-end: 18px;
      border-bottom: solid 1px #444;
    }

    .markdown-table>table th:first-child,
    .markdown-table>table td:first-child {
      padding-left: 12px;
    }

    .markdown-table>table th:last-child,
    .markdown-table>table td:last-child {
      padding-right: 12px;
    }

    .markdown-table>table>tbody>tr:last-child>td {
      border-bottom: none;
    }

    .markdown>hr {
      width: 36px;
      margin: 90px auto;
      border: solid 1.5px #ccc;
      background: #ccc;
      border-radius: 3px;
    }

    .markdown code:not([class]):not([class]) {
      display: inline-block;
      padding: 0 6px;
      border-radius: 6px;
      font-family: var(--default-font, monospace);
      font-size: 15px;
      background: var(--card-clr);
    }

    .markdown>pre:not([class])>code:not([class]) {
      display: block;
      padding: 18px;
      border-radius: 18px;
      line-height: 1.6;
      font-size: 15px;
      overflow-x: auto;
    }

    .markdown>blockquote {
      position: relative;
      margin: 0;
      padding: 18px 24px;
      border-radius: 18px;
      border: solid 1px var(--clr0);
      font-size: 21px;
    }

    .markdown>blockquote::before {
      content: "";
      position: absolute;
      right: 100%;
      top: 0;
      height: 24px;
      width: 24px;
      border-bottom: solid 1px var(--clr0);
      box-sizing: border-box;
    }

    .markdown>blockquote::after {
      content: "";
      position: absolute;
      right: 100%;
      top: 24px;
      bottom: 18px;
      width: 24px;
      border-top-right-radius: 24px;
      border: solid var(--clr0);
      border-width: 1px 1px 0 0;
      box-shadow: 9px 0 0 var(--bg-clr), 18px 0 0 var(--bg-clr);
      box-sizing: border-box;
    }

    .markdown>blockquote> :first-child {
      margin-top: 0;
    }

    .markdown>blockquote> :last-child {
      margin-bottom: 0;
    }

    .markdown>blockquote cite {
      display: block;
      margin-top: 12px;
      font-size: 15px;
      font-style: inherit;
    }

    .markdown>blockquote cite::before {
      content: "‚Äî";
    }

    .markdown>iframe,
    .markdown>p>iframe {
      max-width: calc(100vw - 18px);
      border: none;
      border-radius: 18px;
      background: #fff;
    }

    .markdown .center {
      text-align: center;
    }

    .markdown .center-flex {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* todo? convert to component <blog-bleed>, reuse across <blog-media> */
    .markdown .bleed {
      position: relative;
      left: 50%;
      width: 100vh;
      max-width: max(min(100vw, 800px), 80vw);
      transform: translateX(-50%);
    }

    /* todo: convert to component <caption>, reuse across <blog-media> */
    .markdown .caption {
      display: block;
      font-size: 15px;
    }
  </style>
  <style>
    .demo-row {
      margin: 18px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .demo-caption {
      max-width: 600px;
    }

    .drag-hint {
      padding: 0 0.3rem;
      font-weight: bold;
      border: dashed 2px #fff7;
      border-radius: 2rem;
    }

    .abc-demo-intersects-ac-run,
    .abc-demo-intersects-ac-skip {
      animation: highlight-change 2s 0.5s both;
    }

    @keyframes highlight-change {
      from {
        background: #55440088;
      }
    }

    .pair-legend {
      display: inline-block;
      position: relative;
      top: -4px;
      margin: 0 4px;
      width: 22px;
      height: 2px;
      background: currentColor;
    }

    .pair-legend::before,
    .pair-legend::after {
      content: "";
      position: absolute;
      top: -4px;
      display: block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
    }

    .pair-legend::before {
      left: -2px;
    }

    .pair-legend::after {
      right: -2px;
    }
  </style>
  <style>
    .eq-op {
      color: var(--clr0-light);
    }

    .eq-i {
      color: #e79907;
    }

    .eq-c {
      color: var(--clr1);
    }
  </style>
</head>


<body>

  <div class="page-wrapper">
    <header class="main-header">
      <div class="main-header-bar">
        <a href="/" class="main-header-item ">Home</a>
        <a href="/wares/" class="main-header-item ">Wares</a>
        <img class="main-header-icon" src="/icons/yay_sheet.png" alt="">
        <a href="/art/" class="main-header-item ">Art</a>
        <a href="/notes/" class="main-header-item select">Notes</a>
        <div class="main-header-indicator"></div>
      </div>
    </header>
    <div class="page-wrapper-content">

      <div class="blog-page">

        <div class="content">

          <!-- prettier-ignore -->
          <div class="markdown">
            <p>
            <div class="blog-header">
              <div class="text-with-bg blog-header-title" style="--text-with-bg-color: var(--bg-clr)">
                <h1 class="text-with-bg-span blog-header-title-inner">
                  Sort, sweep, and prune: collision detection algorithms
                </h1>
              </div>
              <img srcset="/notes/sweep-and-prune/hero_800.generated.jpg 800w,/notes/sweep-and-prune/hero_1200.generated.jpg 1200w" sizes="not (min-width:800px) 800px, 1200px" class="blog-header-hero" src="/notes/sweep-and-prune/hero.jpg" alt="" spec="100% [800) 80%">
              <svg xmlns="http://www.w3.org/2000/svg" class="blog-header-decor">
                <path></path>
              </svg>
            </div>
            </p>
            <p>
            <div class="blog-post-info ">
              5 Aug 2023 ¬∑ 13 min read
            </div>
            </p>
            <div class="tag-row">tags:
              <span class="tag-component" title="algorithm" style="background: rgb(107,251,250); color: rgb(9,125,124)">algo</span>
              <span class="tag-component" style="background: rgb(183,234,166); color: rgb(51,105,32)">games</span>
            </div>

            <p>This post is about a neat family of algorithms for detecting collisions among multiple objects. I attempted to explain and demonstrate first principles, so it‚Äôs quite long and is split into two parts. I hope you take the time to read and learn from it! üòÑ</p>
            <hr>
            <h2 id="collision-detection">Collision detection</h2>
            <p>As you may know, the problem of collision detection is pretty common in video game programming. It‚Äôs a prerequisite to the implementation of certain game mechanics or simulations.</p>
            <p>
            <div class="blog-media blog-media-default">
              <img class="blog-media-element" alt="video of mario with goombas bumping into each other" src="/notes/sweep-and-prune/mario.gif" loading="lazy" width="100%" height="" style="aspect-ratio: 1.3333333333333333; background: #6888f8"><span class="blog-media-caption">Goombas colliding</span>
            </div>
            </p>
            <p>Some of these mechanics include: preventing characters from passing through each other, <a target="_blank" class="text-link " href="https://youtu.be/Ky69PjyHCqg">goombas</a> turning around when bumping into another, big cells eating smaller cells in <a target="_blank" class="text-link " href="https://agar.io/">agar.io</a>, or just about any game physics. All of these need collision detection.</p>
            <p>
            <div class="blog-media blog-media-default">
              <img class="blog-media-element" alt="video of agar.io with cells eating smaller cells" src="/notes/sweep-and-prune/agario.gif" loading="lazy" width="100%" height="" style="aspect-ratio: 1.3333333333333333; background: #f8f8f8"><span class="blog-media-caption">Cells consuming smaller cells on contact</span>
            </div>
            </p>
            <p>Here I‚Äôll cover several related approaches, starting with the simplest and building up to the <a target="_blank" class="text-link " href="https://en.wikipedia.org/wiki/Sweep_and_prune"><strong>sweep-and-prune</strong></a> algorithm.</p>
            <p>Balls.</p>
            <p>I‚Äôll use this <strong>rigid-body ball simulation</strong> as a recurring example to demonstrate the algorithms throughout the post:</p>
            <div class="demo-row">
              <sap-demo-client class="" data-rss="interactive" aria-label="demo of the collision detection algorithm using 'sap-nativesort' strategy" strategy="sap-nativesort"></sap-demo-client>
            </div>

            <p>Alright, let‚Äôs dive in! How do we detect these collisions?</p>
            <h2 id="naive-approach-üê•">Naive approach üê•</h2>
            <p>The straightforward solution is to test every potential pair of objects for collision. That is, <em>check every ball against every other ball</em>.</p>
            <pre class="code-block"><code class="code-block-code"><span class="token comment">// for each ball</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> balls<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ball1 <span class="token operator">=</span> balls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// check each of the other balls</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> balls<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ball2 <span class="token operator">=</span> balls<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// check for collision</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">intersects</span><span class="token punctuation">(</span>ball1<span class="token punctuation">,</span> ball2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">bounce</span><span class="token punctuation">(</span>ball1<span class="token punctuation">,</span> ball2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
            <p>Note in the above code that the inner loop starts at <code>i + 1</code> to prevent duplicate pairs from being counted (A-B vs B-A). Other than that, it‚Äôs a pretty simple solution.</p>
            <p>These checks are done on every time step, ensuring that balls will bounce exactly when they collide.</p>
            <p>Here‚Äôs a slowed-down, highlighted simulation, showing pairs being tested for intersection per time step:</p>
            <div class="demo-row">
              <sap-demo-client class="" data-rss="interactive" aria-label="demo of the collision detection algorithm using 'pairwise' strategy" strategy="pairwise" skip-interval="4" decorations="checks:#4c8"></sap-demo-client>
              <div class="demo-caption">
                Pairs are highlighted <span aria-label="a connecting green line" style="color:#4c8" class="pair-legend"></span> when being tested via <code>intersects()</code>.
              </div>
            </div>

            <p>And it works. But if we had more than just a handful of balls we would start seeing performance issues.</p>
            <h2 id="performance-or-lack-thereof">Performance, or lack thereof</h2>
            <p>This naive algorithm runs in <em><strong>O(n<sup>2</sup>)</strong></em> time in <a target="_blank" class="text-link " href="https://en.wikipedia.org/wiki/Big_O_notation">Big O terms</a>. That is, for an input of <em>n</em> balls, the algorithm‚Äôs running time grows proportionally to the <em>square</em> of the input <em>n</em>. That‚Äôs a lot! üìà</p>
            <p>This is because for <em>n</em> balls, there are around <em>(n&nbsp;*&nbsp;(n-1))/2</em> pairs to test, or <em>0.5n<sup>2</sup>&nbsp;-&nbsp;0.5n</em>. For example, if n = 5 there would be a total of 10 pairs. For n = 10, there would be 45 pairs. For n = 15, 105 pairs (!). And so on‚Ä¶ Using Big O notation, we can simplify this information into a compact expression <em>‚ÄúO(n<sup>2</sup>)‚Äù</em></p>
            <p>To (painfully) demonstrate how the performance scales badly for bigger inputs, here‚Äôs a simulation with n&nbsp;=&nbsp;20:</p>
            <div class="demo-row">
              <sap-demo-client class="" data-rss="interactive" aria-label="demo of the collision detection algorithm using 'pairwise' strategy" balls="20" strategy="pairwise" skip-interval="4" decorations="checks:#4c8"></sap-demo-client>
              <div class="demo-caption">
                20 balls = 190 pairs to test
              </div>
            </div>

            <p>That‚Äôs a lot of checks per frame! Clearly, the naive solution does not scale well for large numbers of objects.</p>
            <p>How can we improve this solution?</p>
            <span class="box-note ">
              <p>The worst case running time for <em>any</em> collision detection algorithm is always <em>O(n<sup>2</sup>)</em>. That‚Äôs when all objects intersect simultaneously and you have no choice but to process each of the n<sup>2</sup> collisions.</p>
              <p>Thus, it‚Äôs more practical to compare the average and best cases.</p>
              <p>Having said that, the naive algorithm is still <em>Œò(n<sup>2</sup>)</em> for <em>any</em> case, no matter the number of actual collisions. A lot of room for improvement!</p>
            </span>

            <h2 id="prologue-improving-the-solution">Prologue: Improving the solution</h2>
            <p>Usually when optimising algorithms, you wanna find <strong>redundant or unnecessary work</strong>. Then find a way to consolidate that redundancy. (That sounded corporate-ish.)</p>
            <p>A good place to start would be the <code>intersects()</code> function since it is called for every candidate pair. If we take the <a target="_blank" class="text-link " href="https://gdbooks.gitbooks.io/3dcollisions/content/Chapter2/static_aabb_aabb.html">typical object intersection test</a> to be its implementation, we get a bunch of these <strong>inequality checks</strong>:</p>
            <pre class="code-block"><code class="code-block-code"><span class="token keyword">function</span> <span class="token function">intersects</span><span class="token punctuation">(</span><span class="token parameter">object1<span class="token punctuation">,</span> object2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// compare objects' bounds to see if they overlap</span>
  <span class="token keyword">return</span> object1<span class="token punctuation">.</span>left <span class="token operator">&lt;</span> object2<span class="token punctuation">.</span>right
      <span class="token operator">&amp;&amp;</span> object1<span class="token punctuation">.</span>right <span class="token operator">&gt;</span> object2<span class="token punctuation">.</span>left
      <span class="token operator">&amp;&amp;</span> object1<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> object2<span class="token punctuation">.</span>bottom
      <span class="token operator">&amp;&amp;</span> object1<span class="token punctuation">.</span>bottom <span class="token operator">&gt;</span> object2<span class="token punctuation">.</span>top<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
            <p>In the above code, the <code>intersects()</code> function checks if two objects intersect by comparing opposing bounds from the two objects, for each dimension. (Refer to <a target="_blank" class="text-link " href="https://developer.mozilla.org/en-US/docs/Games/Techniques/3D_collision_detection#aabb_vs._aabb">this MDN article</a> for a better explanation.)</p>
            <p>For now, let‚Äôs focus on just one dimension, say <em>x</em>. Bear with me as I further scope it down to just one <em>direction</em>:</p>
            <pre class="code-block"><code class="code-block-code"><span class="token keyword">function</span> <span class="token function">intersects</span><span class="token punctuation">(</span><span class="token parameter">object1<span class="token punctuation">,</span> object2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> object1<span class="token punctuation">.</span>right <span class="token operator">&gt;</span> object2<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
            <p>Don‚Äôt worry; this scoped-down definition is a surprise tool that can help us later. ;)</p>
            <p>
            <div class="blog-media blog-media-default">
              <img srcset="/notes/sweep-and-prune/surprise-tool_200.generated.jpg 200w" sizes=" 200px" class="blog-media-element" alt="Still of a cartoon mouse saying, 'that‚Äôs a surprise tool that can help us later'" src="/notes/sweep-and-prune/surprise-tool.jpg" spec="200" loading="lazy" width="100%" height="" style="aspect-ratio: 1.2127659574468086; background: #080808">
            </div>
            </p>
            <p>OK, the reason this will work is because of the <code>&amp;&amp;</code> operator‚Äôs <a target="_blank" class="text-link " href="https://en.wikipedia.org/wiki/Short-circuit_evaluation">short-circuit evaluation</a>. That is, <em>if any operand is false, then the whole expression becomes false</em>. So if two objects do not overlap in the x-axis, then we can immediately rule them out as a candidate pair.</p>
            <p><span class="box-note ">It‚Äôs the same idea as the <a target="_blank" class="text-link " href="https://personal.math.vt.edu/mrlugo/sat.html">separating axis theorem</a>, which implies that two objects can‚Äôt collide if there is an axis where their shadows don‚Äôt overlap.</span></p>
            <p>Therefore, an optimisation in just the x dimension can still be a big help.</p>
            <p>Now, let‚Äôs look at these checks in the context of multiple objects. Consider three objects - A, B, and C - in this configuration:</p>
            <p>
            <div class="blog-media blog-media-default">
              <img srcset="/notes/sweep-and-prune/abc_527.generated.png 527w,/notes/sweep-and-prune/abc_664.generated.png 664w" sizes="not (min-width:664px) 527px, 664px" class="blog-media-element" alt="Three objects, from left to right: A, B, and C" src="/notes/sweep-and-prune/abc.png" spec="100% [664) 664" loading="lazy" width="100%" height="" style="aspect-ratio: 2.034749034749035; background: #f8f8f8">
            </div>
            </p>
            <p>There are three potential pairs to be checked here: A-B, B-C, and A-C. Pretend we‚Äôre running them through the redefined <code>intersects()</code> function, like so:</p>
            <pre class="code-block"><code class="code-block-code"><span class="token function">intersects</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">)</span> <span class="token comment">// returns false</span>
<span class="token function">intersects</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span> <span class="token comment">// returns false</span>
<span class="token function">intersects</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span> <span class="token comment">// returns false</span></code></pre>
            <p>Remember, we‚Äôre trying to find redundant work. Looking closer, if we inline the <code>intersects()</code> function (scoped to one x direction) we get:</p>
            <pre class="code-block"><code class="code-block-code"><span class="token constant">A</span><span class="token punctuation">.</span>right <span class="token operator">&gt;</span> <span class="token constant">B</span><span class="token punctuation">.</span>left <span class="token comment">// returns false</span>
<span class="token constant">B</span><span class="token punctuation">.</span>right <span class="token operator">&gt;</span> <span class="token constant">C</span><span class="token punctuation">.</span>left <span class="token comment">// returns false</span>
<span class="token constant">A</span><span class="token punctuation">.</span>right <span class="token operator">&gt;</span> <span class="token constant">C</span><span class="token punctuation">.</span>left <span class="token comment">// returns false</span></code></pre>
            <p>See any redundant work? Maybe abstractify it a little‚Ä¶</p>
            <pre class="code-block"><code class="code-block-code"><span class="token constant">A</span> <span class="token operator">&gt;</span> <span class="token constant">B</span> <span class="token comment">// returns false</span>
<span class="token constant">B</span> <span class="token operator">&gt;</span> <span class="token constant">C</span> <span class="token comment">// returns false</span>
<span class="token constant">A</span> <span class="token operator">&gt;</span> <span class="token constant">C</span> <span class="token comment">// returns false</span></code></pre>
            <p>Voil√†. Due to the <a target="_blank" class="text-link " href="https://www.mathwords.com/t/transitive_property_inequalities.htm"><strong>transitive property of inequality</strong></a>, realise that we don‚Äôt need to run the third test! <em>If we know A&nbsp;&gt;&nbsp;B and B&nbsp;&gt;&nbsp;C are false, then we don‚Äôt need to compute A&nbsp;&gt;&nbsp;C.</em></p>
            <p>So in this example, we don‚Äôt really need to run <code>intersects(A, C)</code>. We‚Äôve skipped one check!</p>
            <pre class="code-block"><code class="code-block-code"><span class="token function">intersects</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">)</span> <span class="token comment">// returns false</span>
<span class="token function">intersects</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span> <span class="token comment">// returns false</span>
<span class="token comment">// I know intersects(A, C) will return false</span></code></pre>
            <p>You might be wondering how this contrived example could apply to general n-body collision detection. A smart reader such as you might also have realised that this skip only works if A, B, and C are in a particular order. Try <span class="drag-hint">dragging</span> the balls below to see when the optimisation applies and when it does not:</p>
            <div class="demo-row">
              <sap-demo-client class=" sap-demo-draggable" data-rss="interactive" aria-label="interactive diagram showing a specific mechanism" id="abc-demo" balls="[[200,250,50],[300,150,55],[450,275,60]]" strategy="sap-nativesort" static="" draggable="" labels="A,B,C" rainbow=""></sap-demo-client>
              <pre class="code-block" style="width: 100%; max-width: 600px"><code class="code-block-code"><span class="token comment">// LIVE OUTPUT:</span>
<span class="token function">intersects</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">)</span> <span class="token comment">// returns <span class="abc-demo-intersects-ab-return">false</span></span>
<span class="token function">intersects</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span> <span class="token comment">// returns <span class="abc-demo-intersects-bc-return">false</span></span>
<span class="abc-demo-intersects-ac-run" style="display: none"><span class="token function">intersects</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">C</span><span class="token punctuation">)</span> <span class="token comment">// returns <span class="abc-demo-intersects-ac-return">false</span></span></span><span class="abc-demo-intersects-ac-skip token comment">//intersects(A, C) will return <span class="abc-demo-intersects-ac-return">false</span></span></code></pre>
            </div>



            <p><span class="box-note "><strong>Tip:</strong> Drag the balls so that they‚Äôre in one of these orders: C‚ÄëB‚ÄëA and A‚ÄëB‚ÄëC</span></p>
            <p>While it‚Äôs true that this skip only works when A, B, and C are ordered, remember that these labels are <em>arbitrary</em>! What if we just decided to always call the leftmost ball A, the middle ball B, and the rightmost C? Then the optimisation would always be applicable! üååüß†</p>
            <p>But wait‚Ä¶ labeling objects according to a defined order is essentially ‚ú®<strong>sorting</strong>‚ú®! What if we sorted the list of objects every time? Would the number of skipped checks be worth the cost of sorting?</p>
            <h2 id="chapter-1-sorting">Chapter 1. Sorting</h2>
            <p>Sorting, inequalities, and optimisation go hand in hand in hand. <em>A sorted list allows us to exploit the transitive property of inequality en masse.</em></p>
            <p>Even if we had to sort the list of objects every frame, the quickest sorting algorithm in general runs in <em>O(n log n)</em> time which is certainly lower than <em>O(n<sup>2</sup>)</em>.</p>
            <p>As hinted by the tri-object example above, sorting the list of objects merely by their x position removes ranges of potential pairs that need to be tested.</p>
            <p>However, objects aren‚Äôt zero-width points. They‚Äôre <em>widthy</em>, by which I mean having a size and occupying an interval in the x-axis, also known as ‚Äúwidth‚Äù. How can one definitively sort by x position if objects span intervals in the x-axis?</p>
            <h2 id="sort-by-min-x">Sort by min x</h2>
            <p>A solution to sorting widthy objects is to sort them by their <strong>minimum x</strong> (their left edge‚Äôs x-coordinate). This technique can be applied to improve the naive approach.</p>
            <p>It involves minimal modifications to the O(n<sup>2</sup>) solution. But it will result in a good chunk of checks skipped. I‚Äôll explain later.</p>
            <p>First, the modified code:</p>
            <pre class="code-block"><code class="code-block-code"><span class="token inserted-sign inserted language-javascript"><span class="token prefix inserted">+</span> <span class="token comment">// sort by min x</span>
<span class="token prefix inserted">+</span> <span class="token function">sortByLeft</span><span class="token punctuation">(</span>balls<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token prefix inserted">+</span> 
</span><span class="token unchanged language-javascript"><span class="token prefix unchanged"> </span> <span class="token comment">// for each ball</span>
<span class="token prefix unchanged"> </span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> balls<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token prefix unchanged"> </span>   <span class="token keyword">const</span> ball1 <span class="token operator">=</span> balls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token prefix unchanged"> </span>   <span class="token comment">// check each of the other balls</span>
<span class="token prefix unchanged"> </span>   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> balls<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token prefix unchanged"> </span>     <span class="token keyword">const</span> ball2 <span class="token operator">=</span> balls<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="token inserted-sign inserted language-javascript"><span class="token prefix inserted">+</span> 
<span class="token prefix inserted">+</span>     <span class="token comment">// stop when too far away</span>
<span class="token prefix inserted">+</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>ball2<span class="token punctuation">.</span>left <span class="token operator">&gt;</span> ball1<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token prefix inserted">+</span> 
</span><span class="token unchanged language-javascript"><span class="token prefix unchanged"> </span>     <span class="token comment">// check for collision</span>
<span class="token prefix unchanged"> </span>     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">intersects</span><span class="token punctuation">(</span>ball1<span class="token punctuation">,</span> ball2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token prefix unchanged"> </span>       <span class="token function">bounce</span><span class="token punctuation">(</span>ball1<span class="token punctuation">,</span> ball2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token prefix unchanged"> </span>     <span class="token punctuation">}</span>
<span class="token prefix unchanged"> </span>   <span class="token punctuation">}</span>
<span class="token prefix unchanged"> </span> <span class="token punctuation">}</span></span></code></pre>
            <p>It‚Äôs mostly the same as the naive solution, differing only in two extra lines of code. (These two juicy lines of code yield a maximum return of investment and is unlikely to be topped by anything else in this post.)</p>
            <p>The first line, <code>sortByLeft(edges)</code>, simply sorts the list. The ranking is based on the balls‚Äô left edge x-coords:</p>
            <pre class="code-block"><code class="code-block-code"><span class="token function-variable function">sortByLeft</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">balls</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> balls<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>left <span class="token operator">-</span> b<span class="token punctuation">.</span>left<span class="token punctuation">)</span></code></pre>
            <p>And in the inner loop, there is now this break:</p>
            <pre class="code-block"><code class="code-block-code"><span class="token keyword">if</span> <span class="token punctuation">(</span>ball2<span class="token punctuation">.</span>left <span class="token operator">&gt;</span> ball1<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span></code></pre>
            <p>Let‚Äôs break that down.</p>
            <p>First, we know that the list is sorted, so the condition
              <code>balls[<span class="eq-i">j</span>].left <span class="eq-op">&lt;</span> balls[<span class="eq-i">j</span> + <span class="eq-c">c</span>].left</code>
              holds true for any positive integer
              <code class="eq-c">c</code>.
            </p>
            <p>Therefore, when
              <code>balls[<span class="eq-i">j</span>].left <span class="eq-op">&gt;</span> ball1.right</code>
              is true, then
              <code>balls[<span class="eq-i">j</span> + <span class="eq-c">c</span>].left <span class="eq-op">&gt;</span> ball1.right</code>
              will also be true.
            </p>
            <p>Because
              <code>balls[<span class="eq-i">j</span> + <span class="eq-c">c</span>].left <span class="eq-op">&gt;</span> balls[<span class="eq-i">j</span>].left <span class="eq-op">&gt;</span> ball1.right</code>.
            </p>
            <p>When that condition is true, the current ball2
              <code>balls[<span class="eq-i">j</span>]</code>,
              and any further ball2s
              <code>balls[<span class="eq-i">j</span> + <span class="eq-c">c</span>]</code>,
              do <em>not</em> intersect ball1. So we can skip the rest of ball2s in the inner loop and move on to the next ball1.
            </p>
            <p>Here‚Äôs a demo:</p>
            <div class="demo-row">
              <sap-demo-client class="" data-rss="interactive" aria-label="demo of the collision detection algorithm using 'simple-sap' strategy" strategy="simple-sap" skip-interval="4" decorations="checks:#4c8"></sap-demo-client>
              <div class="demo-caption">
                Pairs highlighted <span aria-label="a connecting green line" style="color:#4c8" class="pair-legend"></span> when tested by <code>intersects()</code>.
              </div>
            </div>

            <p><strong>Observations:</strong> Since the list is sorted, the checks are performed from left to right. More importantly, it visibly does fewer checks than the naive approach. üìâ</p>
            <p>This is due the above optimisation which limits pairs to only those that overlap in the x-axis!</p>
            <p>Let‚Äôs analyse the time complexity. üëì</p>
            <p>The sort - if we take the "fastest" sorting algorithm, like mergesort or quicksort - would add an <em>O(n log n)</em> term.</p>
            <p>The two-level loop, now with an early break, would average out to <em>O(n&nbsp;+&nbsp;m)</em> where <em>m</em> is the total number of x-overlaps. This could degenerate into n<sup>2</sup> but as mentioned it‚Äôs more useful to look at the average and best cases. At best, the loops would be <em>O(n)</em>, wasting no excess processing if there are no collisions at all. On average it‚Äôs <em>O(n&nbsp;+&nbsp;m)</em>.</p>
            <p><span class="box-note ">The average case refers to a world where objects are mostly evenly distributed and only a couple intersections per object is happening. I think this is a reasonable assumption for a relatively simple video game like a platformer or side-scroller.</span></p>
            <p>Here‚Äôs the code with running time annotations:</p>
            <pre class="code-block"><code class="code-block-code"><span class="token comment">// O(n log n)</span>
<span class="token function">sortByLeft</span><span class="token punctuation">(</span>balls<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// O(n + m)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> balls<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ball1 <span class="token operator">=</span> balls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> balls<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ball2 <span class="token operator">=</span> balls<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ball2<span class="token punctuation">.</span>left <span class="token operator">&gt;</span> ball1<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">intersects</span><span class="token punctuation">(</span>ball1<span class="token punctuation">,</span> ball2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">bounce</span><span class="token punctuation">(</span>ball1<span class="token punctuation">,</span> ball2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
            <p>Adding those together, <em>n&nbsp;log&nbsp;n&nbsp;+&nbsp;n&nbsp;+&nbsp;m</em> we get <em><strong>O(n log n + m)</strong></em>. A big improvement over the naive approach‚Äôs <em>O(n<sup>2</sup>)</em>.</p>
            <p>Furthermore, the choice of sorting algorithm could be improved. Yes, there‚Äôs something better than an <em>n&nbsp;log&nbsp;n</em> sort in this case; we‚Äôll look into that in the next part!</p>
            <span class="box-note ">
              If you got this far trying to find a decent collision detection algorithm, then you can stop reading and take the above design! It‚Äôs the perfect balance between programming effort and running time performance. If you are curious how this develops or just want to see more interactive demos, read the next part.
            </span>

            <h2 id="visual-comparison">Visual comparison</h2>
            <p>Here‚Äôs a side-by-side comparison of the strategies we‚Äôve covered so far! Observe the amount of intersection checks required per frame. üîç</p>
            <div class="demo-row">
              <sap-demo-client class="" data-rss="interactive" aria-label="demo of the collision detection algorithm using 'pairwise' strategy" balls="6" strategy="pairwise" skip-interval="1" decorations="checks:#cbb:30"></sap-demo-client>
              <div class="demo-caption">Global pairwise</div>
            </div>

            <div class="demo-row">
              <sap-demo-client class="" data-rss="interactive" aria-label="demo of the collision detection algorithm using 'sap-nativesort' strategy" balls="6" strategy="sap-nativesort" skip-interval="1" decorations="checks:#bcb:30"></sap-demo-client>
              <div class="demo-caption">Sorted pairwise</div>
            </div>

            <p>(Not shown: the cost of sorting. Let‚Äôs assume the intersection test is sufficiently expensive that it overshadows everything else.)</p>
            <p>Aaand that concludes the first part. Those two lines of code definitely made big impact. Could there be anything better than that?</p>
            <p><a target="_self" class="text-link " href="/notes/sweep-and-prune-2/">Continued in part 2.</a></p>
            <hr>
            <p>Bonus demo, 15 balls! What a mess!</p>
            <div class="demo-row">
              <sap-demo-client class="" data-rss="interactive" aria-label="demo of the collision detection algorithm using 'sap-swap-2d' strategy" balls="15" labels="üçé,üöó,üå∏,üçï,üéà,üåä,üéÆ,üöÄ,üìö,üéµ,üèÜ,üåª,üçî,‚è∞,‚≠ê" rainbow="" strategy="sap-swap-2d"></sap-demo-client>
            </div>

            <p><a target="_self" class="text-link " href="/notes/sweep-and-prune-2/">Continued in part 2.</a>
            </p>

          </div>

        </div>
      </div>

    </div>
    <footer class="main-footer">
      <div class="main-footer-content-part">
        <p class="main-footer-line">
          <a target="_self" class="main-footer-link" href="/">Home</a> ¬∑
          <a target="_self" class="main-footer-link" href="/wares/">Software</a> ¬∑
          <a target="_self" class="main-footer-link" href="/art/">Art</a> ¬∑
          <a target="_self" class="main-footer-link" href="/notes/">Notes</a> ¬∑
          <a target="_self" class="main-footer-link" href="/misc/">Misc</a>
        </p>
        <p class="main-footer-line">
          <img class="main-footer-signature" alt="" src="/icons/laptop_user.png" loading="lazy">
          ¬∑
          <a target="_self" class="main-footer-link" href="/guestbook/">Sign my guestbook</a>
        </p>
        <p class="main-footer-line">
          (C) 2023 Lean Rada.
          <a target="_blank" class="main-footer-link" href="https://github.com/Kalabasa/kalabasa.github.io">
            Source
          </a>
        </p>
      </div>
      <div class="main-footer-content-part">
        <h2 class="main-footer-links-heading">On the web</h2>
        <a target="_blank" class="main-footer-web-link" href="https://www.linkedin.com/in/leanrada/">
          <img class="main-footer-web-link-icon" alt="LinkedIn" src="/icons/linkedin.png" loading="lazy">
        </a>
        <a target="_blank" class="main-footer-web-link" href="https://codepen.io/kalabasa">
          <img class="main-footer-web-link-icon" alt="CodePen" src="/icons/codepen.png" loading="lazy">
        </a>
        <a target="_blank" class="main-footer-web-link" href="https://stackoverflow.com/users/3144156/kalabasa">
          <img class="main-footer-web-link-icon" alt="Stack Overflow" src="/icons/stackoverflow.png" loading="lazy">
        </a>
        <a target="_blank" class="main-footer-web-link" href="https://github.com/Kalabasa" rel="me">
          <img class="main-footer-web-link-icon" alt="GitHub" src="/icons/github.png" loading="lazy">
        </a>
        <h2 class="main-footer-links-heading">Webrings</h2>
        <p class="main-footer-line">
          <img class="main-footer-webring-icon" alt="" src="/icons/planet.png" loading="lazy">
          <a target="_blank" class="main-footer-link" href="http://geekring.net/">geekring.net</a>
          [<a target="_blank" class="main-footer-link" href="http://geekring.net/site/288/previous" aria-label="Previous site">‚Üê</a>
          <a target="_blank" class="main-footer-link" href="http://geekring.net/site/288/random" aria-label="Random site">‚Åô</a>
          <a target="_blank" class="main-footer-link" href="http://geekring.net/site/288/next" aria-label="Next site">‚Üí</a>
          <a target="_blank" class="main-footer-link" href="http://geekring.net/site/288/frameset" aria-label="Frameset browsing">‚ñ£</a>]
        </p>
        <p class="main-footer-line">
          <img class="main-footer-webring-icon" alt="" src="/icons/planet.png" loading="lazy">
          <a target="_blank" class="main-footer-link" href="https://cs.sjoy.lol/">CSS JOY</a>
          [<a target="_blank" class="main-footer-link" href="https://webri.ng/webring/cssjoy/previous?via=https%3A%2F%2Fleanrada.com" aria-label="Previous site">‚Üê</a>
          <a target="_blank" class="main-footer-link" href="https://webri.ng/webring/cssjoy/random?via=https%3A%2F%2Fleanrada.com" aria-label="Random site">‚Åô</a>
          <a target="_blank" class="main-footer-link" href="https://webri.ng/webring/cssjoy/next?via=https%3A%2F%2Fleanrada.com" aria-label="Next site">‚Üí</a>]
        </p>
      </div>
      <nebula-client class="main-footer-nebula" palette="#0ad591 #ff2b75 #ffb833 #0ad591 #0ad591 #4d4aff #0ad591" width="40" height="10">
        <canvas style="filter: contrast(1.5)"></canvas>
        <div class="nebula-noise"></div>
      </nebula-client>
      <a class="main-footer-top-btn" href="#top" aria-label="Back to top">^</a>
    </footer>
  </div>




  <script defer="" src="/scripts/blog-media.js"></script>
  <script defer="" src="/scripts/blog-header.js"></script>
  <script defer="" src="/scripts/main-footer-main-header.js"></script>
  <script defer="">
    (() => {
      const abcDemo = document.querySelector("#abc-demo");
      const intersectsAbReturn = document.querySelectorAll(".abc-demo-intersects-ab-return");
      const intersectsBcReturn = document.querySelectorAll(".abc-demo-intersects-bc-return");
      const intersectsAcReturn = document.querySelectorAll(".abc-demo-intersects-ac-return");
      const intersectsAcRun = document.querySelectorAll(".abc-demo-intersects-ac-run");
      const intersectsAcSkip = document.querySelectorAll(".abc-demo-intersects-ac-skip");

      abcDemo.addEventListener("simulate", throttle((event) => {
        const [A, B, C] = event.balls;
        setText(intersectsAbReturn, String(A.x > B.x));
        setText(intersectsBcReturn, String(B.x > C.x));
        setText(intersectsAcReturn, String(A.x > C.x));
        const acRuns = (A.x > B.x) !== (B.x > C.x);
        setShow(intersectsAcRun, acRuns);
        setShow(intersectsAcSkip, !acRuns);
      }));

      function setText(elements, text) {
        for (const element of elements)
          if (element.textContent !== text)
            element.textContent = text;
      }

      function setShow(elements, show) {
        for (const element of elements)
          if ((element.offsetParent != null) !== show)
            element.style.display = show ? "block" : "none";
      }

      function throttle(func, ms = 100) {
        let lastTime = Date.now();
        return (...args) => {
          if (Date.now() - lastTime < ms) return;
          lastTime = Date.now();
          func(...args);
        };
      }
    })();
  </script>
</body>
</html>