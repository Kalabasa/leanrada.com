<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="syndication" href="https://www.reddit.com/r/IndieDev/comments/14nu6zf/i_made_a_potentialfield_based_algorithm_for/">
  <title>Dynamic patrol behaviour in stealth games with Markov chains · leanrada.com</title>
  <script async="" src="/lib/vendor/perlin-noise-3d.min.js"></script>
  <link rel="preload" href="/fonts/space/SpaceMono-Italic.ttf" as="font" type="font/ttf" crossorigin="">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="webmention" href="https://webmention.io/leanrada.com/webmention">
  <link rel="alternate" type="application/rss+xml" title="leanrada.com feed" href="/rss.xml">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="only dark">
  <meta charset="utf-8">
  <script async="" src="https://leanrada.com/analytics/analytics.js"></script>
  <style>
  .reactions {
    display: grid;
    grid-template-rows: repeat(3, auto);
    grid-auto-flow: column;
    justify-content: center;
    justify-items: center;
    gap: 6px;
    border: solid 1px var(--card-clr);
    border-radius: 6px;
    padding: 18px;
    font-family: var(--default-font);
  }

  .reaction-title {
    grid-column: span 5;
    margin: 0 0 6px;
    font-size: 18px;
  }

  .reaction-heart-btn,
  .reaction-heart-count {
    --reaction-color: #bf1852;
  }
  .reaction-fire-btn,
  .reaction-fire-count {
    --reaction-color: #c68306;
  }
  .reaction-bubble-btn,
  .reaction-bubble-count {
    --reaction-color: #07bd80;
  }
  .reaction-sun-btn,
  .reaction-sun-count {
    --reaction-color: #a09b00;
  }
  .reaction-cloud-btn,
  .reaction-cloud-count {
    --reaction-color: #8063ff;
  }

  .reaction-count {
    position: relative;
    font-size: 18px;
    width: 100%;
    height: 18px;
    text-align: center;
    overflow: hidden;
  }
  .reaction-count-prev,
  .reaction-count-next {
    position: relative;
    height: 100%;
    animation: reaction-tick 0.3s var(--ease) forwards;
  }

  @keyframes reaction-tick {
    from {
      top: 0;
    }
    to {
      top: -100%;
    }
  }

  .reaction-count.reaction-spark::after {
    position: absolute;
    content: "";
    width: 36px;
    height: 36px;
    left: calc(50% - 18px);
    top: calc(100% - 18px);
    border-radius: 50%;
    animation: reaction-spark 0.1s ease-out;
  }

  @keyframes reaction-spark {
    from {
      box-shadow: inset 0 0 0 18px var(--reaction-color);
    }
    to {
      box-shadow: inset 0 0 0 0px var(--reaction-color);
    }
  }

  .reaction-btn {
    background: none;
    border: none;
    border-radius: 6px;
    width: 32px;
    height: 32px;
    padding: 2px;
    box-sizing: content-box;
    cursor: pointer;
  }
  .reaction-btn:focus-visible,
  .reaction-btn:hover {
    background: var(--reaction-color);
  }
  .reaction-btn:focus-visible .reaction-icon,
  .reaction-btn:hover .reaction-icon {
    animation-duration: 0.5s;
  }
  .reaction-btn:active .reaction-icon {
    position: relative;
    top: 2px;
  }

  .reaction-icon {
    display: block;
    width: 100%;
    height: 100%;
    image-rendering: pixelated;
    background-image: url("/icons/reactions.png");
    background-size: 500% 200%;
    animation: reaction-icon 1.5s steps(2) infinite;
  }
  .reaction-heart-btn .reaction-icon {
    --sheet-x: 25%;
  }
  .reaction-bubble-btn .reaction-icon {
    --sheet-x: 0%;
  }
  .reaction-sun-btn .reaction-icon {
    --sheet-x: 100%;
  }
  .reaction-cloud-btn .reaction-icon {
    --sheet-x: 75%;
  }
  .reaction-fire-btn .reaction-icon {
    --sheet-x: 50%;
  }

  @keyframes reaction-icon {
    0% {
      background-position: var(--sheet-x) 0%;
    }
    100% {
      background-position: var(--sheet-x) 200%;
    }
  }
</style>
  <style>
  .text-link {
    color: var(--clr0-light, #fff);
  }
  .text-link:visited {
    color: var(--clr0, #fff);
  }
</style>
  <style>
  .box-note {
    display: block;
    padding: 12px 18px;
    border-radius: 12px;
    border: solid 2px var(--clr0-dark);
    box-sizing: border-box;
  }
</style>
  <style>
  .blog-media {
    position: relative;
    text-align: center;
    /* external margin because it’s expected to be in an article */
    margin: 36px 0;
  }
  .blog-media-bleed {
    margin: 90px 0;
    max-height: 80vh;
  }

  .blog-media-element {
    display: inline-block;
    max-width: 100%;
    max-height: 80vh;
    border-radius: 18px;
    box-sizing: border-box;
  }
  .blog-media-bleed .blog-media-element {
    position: relative;
    left: 50%;
    max-width: max(min(100vw, 800px), 80vw);
    transform: translateX(-50%);
  }
  .blog-media-windowed .blog-media-element {
    border-radius: 0;
  }

  .blog-media-caption {
    display: block;
    font-size: 15px;
  }
</style>
  <style>
  dynamic-patrol-demo-client {
    position: relative;
    left: 50%;
    transform: translateX(-50%);
    display: inline-block;
    width: 400px;
    width: min(100vw, 70vh);
    aspect-ratio: 1;
    border-radius: 12px;
    background: #cdd;
    overflow: hidden;
  }
</style>
  <style>
  .tag-component {
    display: inline-block;
    padding: 0 3px;
    height: 16px;
    line-height: 16px;
    font-family: var(--default-font);
    font-size: 12px;
    font-weight: bold;
    background: #ccc;
    color: #444;
    border-radius: 3px;
  }
</style>
  <style>
  .tag-row {
    font-family: var(--default-font);
    font-size: 12px;
    font-weight: bold;
  }
</style>
  <style>
  .blog-post-info {
    margin: 24px 0;
    font-family: var(--default-font);
    font-size: 12px;
    font-weight: bold;
    text-align: center;
    color: var(--text2-clr);
  }
  .blog-post-info-hidden {
    display: none;
  }
</style>
  <style>
  .text-with-bg-span {
    display: inline;
    margin: 0;
    padding: 0.7em;
    padding: 0.35lh;
    border-radius: 18px;
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
    font: inherit;
    background: var(--text-with-bg-color);
  }
</style>
  <style>
  .blog-header {
    isolation: isolate;
    margin: 90px 0 24px;
    position: relative;
    left: 50%;
    height: 400px; /* .blog-header-title::before must match */
    width: max(800px, 60vw);
    transform: translateX(-50%);
    box-sizing: border-box;
  }

  .blog-header-title {
    position: relative;
    max-width: 800px;
    font-family: var(--display-font);
    font-size: 36px;
    font-weight: bold;
    font-style: italic;
    text-align: left;
    z-index: 2;
  }
  .blog-header-title-inner {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
  }
  /* Wrap lines in an angle */
  .blog-header-title::before {
    content: "";
    width: 0;
    width: calc(min(50%, 120vw - 600px));
    height: 400px;
    float: right;
    shape-outside: polygon(100% 0%, 20% 30%, 0% 100%, 100% 100%, 100% 0%);
  }

  .blog-header-hero {
    position: absolute;
    inset: 1px;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 18px;
    background: gray;
    z-index: -1;
  }

  .blog-header-decor {
    position: absolute;
    inset: 0;
    pointer-events: none;
    fill: var(--bg-clr);
    z-index: 1;
  }

  @media (max-width: 800px) {
    .blog-header {
      width: 100vw;
      width: 100svw;
      height: 400px;
      padding-right: 36px;
    }
    .blog-header-title {
      font-size: clamp(24px, 20px + 2vw, 36px);
    }
  }
</style>
  <style>
  @font-face {
    font-family: "Space Mono";
    font-display: swap;
    font-weight: normal;
    font-style: normal;
    src: url("/fonts/space/SpaceMono-Regular.ttf") format("truetype");
  }

  @font-face {
    font-family: "Space Mono";
    font-display: swap;
    font-weight: normal;
    font-style: italic;
    src: url("/fonts/space/SpaceMono-Italic.ttf") format("truetype");
  }

  @font-face {
    font-family: "Iosevka";
    font-display: swap;
    font-weight: normal;
    font-style: normal;
    src: url("/fonts/iosevka/iosevka-custom-regular.woff2") format("woff2");
  }

  @font-face {
    font-family: "Iosevka";
    font-display: swap;
    font-weight: normal;
    font-style: italic;
    src: url("/fonts/iosevka/iosevka-custom-italic.woff2") format("woff2");
  }

  @font-face {
    font-family: "Miriam Libre";
    font-display: swap;
    font-weight: normal;
    font-style: normal;
    src: url("/fonts/miriam/MiriamLibre-Regular.ttf") format("truetype");
  }

  :root {
    --default-font: "Iosevka", "Space Mono", monaco, Consolas, "Lucida Console",
      monospace;
    --display-font: "Space Mono", "Iosevka", monaco, Consolas, "Lucida Console",
      monospace;
    --reading-font: "Miriam Libre", Futura, "Trebuchet MS", Arial, sans-serif;

    --bg-clr: #111616;
    --card-clr: #222c2c;
    --clr0-light: #54f8c1;
    --clr0: #0ad591;
    --clr0-dark: #05b97d;
    --clr1: #df2063;

    --text-clr: #fff;
    --text2-clr: #999;

    --ease: cubic-bezier(0.8, 0, 1, 1);
  }

  body {
    margin: 0;
    min-height: 100vh;
    font-family: var(--default-font, monospace);
    font-size: 15px;
    font-display: swap;
    font-variant-ligatures: none;
    background-color: var(--bg-clr, #111);
    color: var(--text-clr, #fff);
    overflow-x: hidden;
  }
  .page-wrapper {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  .page-wrapper-content {
    flex: 1 1 auto;
  }
</style>
  <style>
  nebula-client {
    position: relative;
  }
  nebula-client > canvas {
    width: 100%;
    height: 100%;
  }
  .nebula-noise {
    position: absolute;
    inset: 0;
    background: url("/noise.png"); /* todo: encapsulate noise.png */
    opacity: 0.1;
    animation: nebula-noise-x 0.16s steps(2, jump-start) infinite,
      nebula-noise-y 0.48s steps(3, jump-start) infinite;
  }
  @supports (mix-blend-mode: overlay) {
    .nebula-noise {
      mix-blend-mode: overlay;
      opacity: 0.2;
    }
  }
  @keyframes nebula-noise-x {
    to {
      background-position-x: 100px;
    }
  }
  @keyframes nebula-noise-y {
    to {
      background-position-y: 100px;
    }
  }
</style>
  <style>
  .main-footer-web-link {
    text-decoration: none;
  }

  .main-footer-web-link-icon {
    width: 32px;
    height: 32px;
    image-rendering: pixelated;
  }
  .main-footer-web-link-icon:hover {
    filter: invert(1);
  }
</style>
  <style>
  .main-footer {
    position: relative;
    display: flex;
    justify-content: space-between;
    gap: 60px;
    padding: 42px calc(max(36px, 50vw - 600px));
    font-family: var(--display-font);
    font-size: 15px;
    font-weight: bold;
    background: var(--clr0);
    color: #000;
    overflow: hidden;
    content-visibility: auto;
    contain-intrinsic-height: 200px;
  }

  .main-footer-links-heading {
    margin: 18px 0;
    font-size: inherit;
  }

  .main-footer-line {
    margin: 18px 0;
  }

  .main-footer-link {
    color: #000;
  }
  .main-footer-link:hover {
    color: #000;
  }

  .main-footer-webring-icon {
    width: 16px;
    height: 16px;
    image-rendering: pixelated;
  }

  .main-footer-signature {
    width: 64px;
    height: 64px;
    image-rendering: pixelated;
    vertical-align: middle;
  }

  .main-footer-content-part {
    z-index: 1;
  }

  .main-footer-nebula {
    position: absolute;
    left: -30%;
    top: -30%;
    width: 160%;
    height: 160%;
    z-index: 0;
  }

  .main-footer-top-btn {
    display: block;
    z-index: 2;
    position: absolute;
    right: 0;
    top: 0;
    width: 72px;
    height: 36px;
    padding-right: 9px;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    align-items: center;
    border: none;
    border-bottom-left-radius: 18px;
    background: var(--bg-clr);
    text-decoration: none;
    color: var(--clr0-light);
    font: inherit;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
  }
  .main-footer-top-btn:hover {
    color: var(--clr1);
  }
  .main-footer-top-btn::before {
    content: "";
    position: absolute;
    right: 0;
    top: 0;
    width: 36px;
    height: 18px;
    border-top-right-radius: 18px;
    transform: translateX(-72px);
    box-shadow: 18px 0 0 var(--bg-clr);
  }

  @media (max-width: 700px) {
    .main-footer {
      flex-direction: column-reverse;
    }
  }
</style>
  <style>
  .main-header {
    position: sticky;
    top: 0;
    width: 100%;
    height: 60px;
    padding: 0 calc(25% - 150px);
    z-index: 100;
    box-sizing: border-box;
    pointer-events: none;
  }
  .main-header.float {
    position: fixed;
  }

  .main-header-bar {
    position: relative;
    display: flex;
    justify-content: space-evenly;
    align-items: flex-end;
    height: 100%;
  }

  .main-header-item {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 6ch;
    height: 36px;
    padding: 0 18px;
    border-radius: 18px;
    font-family: var(--display-font);
    font-size: 13px;
    font-weight: bold;
    letter-spacing: 1px;
    text-decoration: none;
    text-transform: uppercase;
    color: #fff;
    backdrop-filter: blur(8px);
    background-color: #2222;
    background-image: linear-gradient(60deg, #9994 60%, transparent 60%);
    background-repeat: no-repeat;
    background-size: 220% 100%;
    background-position: 115%;
    pointer-events: all;
    transition: background-color 0.2s var(--ease),
      background-position 0.2s var(--ease);
  }
  .main-header-item:hover {
    background-image: linear-gradient(
      60deg,
      #9994 50%,
      #fff 50%,
      #fff 60%,
      transparent 60%
    );
    background-position: 0%;
  }
  .main-header-item.select {
    background: #9994;
  }

  .main-header-icon {
    width: 48px;
    height: 48px;
    border-radius: 25%;
    image-rendering: pixelated;
    object-fit: cover;
    filter: invert(1);
    backdrop-filter: blur(8px) invert(1);
    pointer-events: all;
  }
  @media (max-width: 450px) {
    .main-header-icon {
      display: none;
    }
  }
  .main-header-icon-yay {
    border-radius: 50%;
    object-position: 0 0;
  }
  .main-header-icon-yay:hover {
    object-position: 100% 0;
  }

  .main-header-indicator {
    position: absolute;
    width: 6px;
    height: 6px;
    left: 50%;
    top: calc(100% + 12px);
    transform: translate(-50%, -50%);
    /* border acts as extended touch area */
    border: solid 6mm transparent;
    border-left-width: 45vw;
    border-right-width: 45vw;
    border-radius: 50%;
    background: #fff;
    background-clip: padding-box;
    opacity: 0;
    transition: opacity 50ms;
  }
  .main-header.hidden .main-header-indicator {
    opacity: 0.6;
    pointer-events: all;
  }
</style>
  <style>
  .blog-page {
    margin: auto;
    overflow: hidden;
  }

  .content {
    margin: auto;
    padding: 0 18px 60px;
    width: 100%;
    max-width: 700px;
    font-family: var(--reading-font, sans-serif);
    font-size: 16px;
    line-height: 2.2;
    letter-spacing: 0.02em;
    color: #ddd;
    box-sizing: border-box;
  }

  .postcontent {
    margin: auto;
    padding: 0 18px 60px;
    width: 100%;
    max-width: 700px;
  }

  .markdown > h1,
  .markdown > h2,
  .markdown > h3,
  .markdown > h4,
  .markdown > h5,
  .markdown > h6 {
    margin: 48px 0 36px;
    font-family: var(--display-font);
    font-weight: normal;
    font-style: italic;
    line-height: 1.6;
    letter-spacing: 0.04em;
    text-wrap: balance;
  }
  .markdown > h1 {
    text-align: center;
    font-size: 200%;
  }
  .markdown > h2 {
    font-size: 150%;
  }
  .markdown > h3,
  .markdown > h4,
  .markdown > h5,
  .markdown > h6 {
    font-size: 120%;
    font-weight: bold;
  }

  .markdown > p {
    margin: 36px 0;
  }
  .markdown .box-note > p {
    margin: 18px 0;
  }
  .markdown .box-note > p:first-child {
    margin-top: 0;
  }
  .markdown .box-note > p:last-child {
    margin-bottom: 0;
  }

  .markdown-table {
    margin: 0 -18px; /* bleed content padding */
    padding: 0 18px; /* bleed content padding */
    overflow-x: auto;
  }
  .markdown-table > table {
    min-width: 100%;
    box-sizing: border-box;
    border-collapse: collapse;
    background-color: var(--card-clr);
    border-radius: 12px;
  }
  .markdown-table > table th,
  .markdown-table > table td {
    min-width: min(25vw, 8ch);
    box-sizing: border-box;
    text-align: start;
    padding: 9px 6px;
    padding-inline-end: 18px;
    border-bottom: solid 1px #444;
  }
  .markdown-table > table th:first-child,
  .markdown-table > table td:first-child {
    padding-left: 12px;
  }
  .markdown-table > table th:last-child,
  .markdown-table > table td:last-child {
    padding-right: 12px;
  }
  .markdown-table > table > tbody > tr:last-child > td {
    border-bottom: none;
  }

  .markdown > hr {
    width: 36px;
    margin: 90px auto;
    border: solid 1.5px #ccc;
    background: #ccc;
    border-radius: 3px;
  }

  .markdown code:not([class]):not([class]) {
    display: inline-block;
    padding: 0 6px;
    border-radius: 6px;
    font-family: var(--default-font, monospace);
    font-size: 15px;
    background: var(--card-clr);
  }
  .markdown > pre:not([class]) > code:not([class]) {
    display: block;
    padding: 18px;
    border-radius: 18px;
    line-height: 1.6;
    font-size: 15px;
    overflow-x: auto;
  }

  .markdown > blockquote {
    position: relative;
    margin: 0;
    padding: 18px 24px;
    border-radius: 18px;
    border: solid 1px var(--clr0);
    font-size: 21px;
  }
  .markdown > blockquote::before {
    content: "";
    position: absolute;
    right: 100%;
    top: 0;
    height: 24px;
    width: 24px;
    border-bottom: solid 1px var(--clr0);
    box-sizing: border-box;
  }
  .markdown > blockquote::after {
    content: "";
    position: absolute;
    right: 100%;
    top: 24px;
    bottom: 18px;
    width: 24px;
    border-top-right-radius: 24px;
    border: solid var(--clr0);
    border-width: 1px 1px 0 0;
    box-shadow: 9px 0 0 var(--bg-clr), 18px 0 0 var(--bg-clr);
    box-sizing: border-box;
  }
  .markdown > blockquote > :first-child {
    margin-top: 0;
  }
  .markdown > blockquote > :last-child {
    margin-bottom: 0;
  }
  .markdown > blockquote cite {
    display: block;
    margin-top: 12px;
    font-size: 15px;
    font-style: inherit;
  }
  .markdown > blockquote cite::before {
    content: "—";
  }

  .markdown > iframe,
  .markdown > p > iframe {
    max-width: calc(100vw - 18px);
    border: none;
    border-radius: 18px;
    background: #fff;
  }

  .markdown .center {
    text-align: center;
  }
  .markdown .center-flex {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  /* todo? convert to component <blog-bleed>, reuse across <blog-media> */
  .markdown .bleed {
    position: relative;
    left: 50%;
    width: 100vh;
    max-width: max(min(100vw, 800px), 80vw);
    transform: translateX(-50%);
  }

  /* todo: convert to component <caption>, reuse across <blog-media> */
  .markdown .caption {
    display: block;
    font-size: 15px;
  }
</style>
  <style>
  .small-diagram-row {
    margin: -36px 0;
    display: flex;
    gap: 12px;
  }
  .small-diagram-row * {
    flex: 1 1 50%;
  }
  .small-diagram-row-solo {
    margin-left: 25%;
    margin-right: 25%;
  }
  @media (max-width: 600px) {
    .small-diagram-row {
      margin-left: 0;
      margin-right: 0;
      flex-direction: column;
    }
  }
</style>
  <style>
        /* couldn't style the table without breaking markdown. quik hax */
        .probability-table th:nth-child(n + 3):not(:has(strong))::before,
        .probability-table td:nth-child(n + 3):not(:has(strong))::before,
        .probability-table th:nth-child(n + 3) strong::before,
        .probability-table td:nth-child(n + 3) strong::before {
          content: "➡ ";
          color: inherit;
        }
        .probability-table tr th:nth-child(3),
        .probability-table tr td:nth-child(3) strong {
          color: #f88;
        }
        .probability-table tr th:nth-child(4),
        .probability-table tr td:nth-child(4) strong {
          color: #8ff;
        }
      </style>
</head>



<body>


  <div class="page-wrapper">
    <header class="main-header">
      <div class="main-header-bar">
        <a href="/" class="main-header-item ">Home</a> <a href="/wares/" class="main-header-item ">Wares</a>
        <img class="main-header-icon main-header-icon-yay" src="/icons/yay_sheet.png" alt="">
        <a href="/art/" class="main-header-item ">Art</a> <a href="/notes/" class="main-header-item select">Notes</a>
        <div class="main-header-indicator"></div>
      </div>
    </header>
    <div class="page-wrapper-content">

      <div class="blog-page">

        <div class="content">

          <!-- prettier-ignore -->
          <div class="markdown">
            <p>
            <div class="blog-header">
              <div class="text-with-bg blog-header-title" style="--text-with-bg-color: var(--bg-clr)">
                <h1 class="text-with-bg-span blog-header-title-inner">
                  Dynamic patrol behaviour in stealth games with Markov chains
                </h1>
              </div>
              <img srcset="/notes/dynamic-patrol-stealth-games/hero_800.generated.jpg 800w,/notes/dynamic-patrol-stealth-games/hero_1020.generated.jpg 1020w,/notes/dynamic-patrol-stealth-games/hero_1400.generated.jpg 1400w" sizes="not (min-width:800px) 800px,(max-width:1275px) 1020px, 1400px" class="blog-header-hero" src="/notes/dynamic-patrol-stealth-games/hero.jpg" alt="" spec="100% [800) 80%">
              <svg xmlns="http://www.w3.org/2000/svg" class="blog-header-decor">
                <path></path>
              </svg>
            </div>
            </p>
            <p>
            <div class="blog-post-info ">
              1 Jul 2023 · 9 min read
            </div>
            </p>
            <div class="tag-row">tags:
              <span class="tag-component" title="algorithm" style="background: rgb(107,251,250); color: rgb(9,125,124)">algo</span>
              <span class="tag-component" style="background: rgb(183,234,166); color: rgb(51,105,32)">games</span>
            </div>

            <p>Hi, this post is about a game AI algorithm for stealth games.</p>
            <p>But first, here’s a preview demo! Full demo at the end of this post. In between, I’ll explain the background, the process, and the results!</p>
            <p><dynamic-patrol-demo-client tabindex="0" data-rss="interactive" aria-label="interactive demo of the dynamic patrol algorithm" map="
        ###################
        #....#....#.......#
        #....#....#.......#
        #....#....#.......#
        ##.####.###.......#
        #.................#
        #.................#
        ##.####.###.......#
        #...#....#####..###
        #...#....#####..###
        #...#...G#####..###
        ##########.......##
        ##########.......##
        ##########.......##
        ##########.......##
        ###################
      "></dynamic-patrol-demo-client></p>
            <h2 id="background">Background</h2>
            <p>I enjoy stealth games. However, I felt like the genre has become formulaic. Nowadays, we have standardised light, shadow, and noise mechanics. We almost always get discrete levels of alertness where on one end NPCs have wallhacks while on the other, NPCs have amnesia.</p>
            <p>
            <div class="blog-media blog-media-default">
              <img srcset="/notes/dynamic-patrol-stealth-games/sc_664.generated.jpg 664w" sizes=" 664px" class="blog-media-element" alt="Screenshot of Splinter Cell" src="/notes/dynamic-patrol-stealth-games/sc.jpg" spec="100% [664) 664" loading="lazy" width="100%" height="" style="aspect-ratio: 1.6; background: #080808"><span class="blog-media-caption">Screenshot of Splinter Cell: Chaos Theory from mobygames.com. This game is good.</span>
            </div>
            </p>
            <p>The most immersion-breaking moment for me was when you get spotted, the subsequent investigation consists solely of staring at the ground where you were last seen. Like when you get spotted at an entrance to a room, guards will just stare at the doorway. <em>Why not check inside the room?</em></p>
            <p><span class="box-note ">Yeah, I know, game designers don’t deem smart game AI “fun”. But an easy predictable game is no fun! Whatever, I just wanted to share this prototype.</span></p>
            <p>What was lacking in stealth game AI is inference - the ability to infer that when a target enters a room, then they subsequently must be inside the room.</p>
            <h2 id="a-room-and-a-hallway">A room and a hallway</h2>
            <p>As an example, here are a room and a hallway with a doorway in between, modelled as a <a target="_blank" class="text-link " href="https://en.wikipedia.org/wiki/Graph">graph</a>:</p>
            <div class="small-diagram-row small-diagram-row-solo">
              <div class="blog-media blog-media-default">
                <img srcset="/notes/dynamic-patrol-stealth-games/room-graph_300.generated.png 300w" sizes=" 300px" class="blog-media-element" alt="Node graph representing a room node, a doorway node, and hallway nodes" src="/notes/dynamic-patrol-stealth-games/room-graph.png" spec="300" loading="lazy" width="100%" height="" style="aspect-ratio: 0.9669117647058824; background: #986868">
              </div>
            </div>

            <p>If we assign a number to each node representing the probability that the target (the player) is there, we can start making inferences of where the target could be at later times.</p>
            <p>Let’s say the target was just seen in room <em>R</em>. At that exact moment, there is complete certainty that the target is there, so node <em>R</em> will be assigned a probability of <strong>1.0</strong>.</p>
            <div class="small-diagram-row small-diagram-row-solo">
              <div class="blog-media blog-media-default">
                <img srcset="/notes/dynamic-patrol-stealth-games/room-graph-r1_300.generated.png 300w" sizes=" 300px" class="blog-media-element" alt="Node graph representing the room node with 1.0, the doorway node with 0.0, and hallway nodes with 0.0" src="/notes/dynamic-patrol-stealth-games/room-graph-r1.png" spec="300" loading="lazy" width="100%" height="" style="aspect-ratio: 0.9705882352941176; background: #e8e8e8">
              </div>
            </div>

            <p>After that moment however, the certainty fades. Because the target could have exited the room next, or maybe they stayed.</p>
            <p>The graph is recalculated to reflect this uncertainty by distributing the probability value of <strong>1.0</strong> from node <em>R</em> to each possible choice of node - <em>D</em> (exit) and <em>R</em> (stay). We don’t know the likeliness of either happening so we can just assume equal chances, giving them <strong>0.5</strong> each.</p>
            <div class="small-diagram-row small-diagram-row-solo">
              <div class="blog-media blog-media-default">
                <img srcset="/notes/dynamic-patrol-stealth-games/room-graph-r1d1_300.generated.png 300w" sizes=" 300px" class="blog-media-element" alt="Node graph representing the room node with 0.5, the doorway node with 0.5, and hallway nodes with 0.0" src="/notes/dynamic-patrol-stealth-games/room-graph-r1d1.png" spec="300" loading="lazy" width="100%" height="" style="aspect-ratio: 0.9705882352941176; background: #e8e8e8">
              </div>
            </div>

            <p>Now there is 50% probability that the target is in the room, and 50% in the doorway. This process is repeated for each node over time to calculate the target’s potential location at any given moment.</p>
            <p>Let’s do another iteration. The next one is a bit tricky, but it’s all calculated the same. We just need to calculate the distribution from each node <em>in parallel</em>, like so:</p>
            <div class="small-diagram-row">
              <div class="blog-media blog-media-default">
                <img srcset="/notes/dynamic-patrol-stealth-games/room-graph-r1d1t_300.generated.png 300w" sizes=" 300px" class="blog-media-element" alt="Node graph representing the distribution from previous state" src="/notes/dynamic-patrol-stealth-games/room-graph-r1d1t.png" spec="300" loading="lazy" width="100%" height="" style="aspect-ratio: 0.9705882352941176; background: #e8e8e8"><span class="blog-media-caption">Split the probabilities per node to each possible choice (including staying).</span>
              </div>
              <div class="blog-media blog-media-default">
                <img srcset="/notes/dynamic-patrol-stealth-games/room-graph-r5d5h2_300.generated.png 300w" sizes=" 300px" class="blog-media-element" alt="Node graph representing the room node with 0.42, the doorway node with 0.42, and the hallway node H1 directly next to the doorway with 0.16" src="/notes/dynamic-patrol-stealth-games/room-graph-r5d5h2.png" spec="300" loading="lazy" width="100%" height="" style="aspect-ratio: 0.9705882352941176; background: #e8e8e8"><span class="blog-media-caption">Then sum up the values that arrived in each node.</span>
              </div>
            </div>

            <p><strong>Explanation of above:</strong> The <strong>0.5</strong> at <em>R</em> is split into two, giving <strong>0.5 / 2 = 0.25</strong> each to <em>R</em> and <em>D</em>. Meanwhile, the <strong>0.5</strong> at <em>D</em> is split into three, giving <strong>0.5 / 3 ≈ 0.16</strong> each to <em>R</em>, <em>D</em>, and <em>H1</em>. Then node values are added together in a separate step after the split.</p>
            <p>After some time, we will get a picture of where the target is likely to be and a smarter game AI can utilise this to send guards on a more realistic investigation route.</p>
            <p>Another iteration and we get this:</p>
            <div class="small-diagram-row small-diagram-row-solo">
              <div class="blog-media blog-media-default">
                <img srcset="/notes/dynamic-patrol-stealth-games/room-graph-final_300.generated.png 300w" sizes=" 300px" class="blog-media-element" alt="Node graph representing the room node with 0.35, the doorway node with 0.39, hallway nodes H0 and H2 with 0.04, and H1 with 0.18" src="/notes/dynamic-patrol-stealth-games/room-graph-final.png" spec="300" loading="lazy" width="100%" height="" style="aspect-ratio: 0.9688073394495413; background: #e8e8e8"><span class="blog-media-caption">The state after some time</span>
              </div>
            </div>

            <p>What I’ve just described is some generalisation of a <strong><a target="_blank" class="text-link " href="https://en.wikipedia.org/wiki/Markov_chain">Markov chain</a></strong>. Well, it’s not exactly accurate to call it that since the Markov chain is just one part of the algorithm. You’ll see why in the next section.</p>
            <p><span class="box-note "><strong>Disclaimer:</strong> I wasn’t thinking about Markov chains while developing this algorithm. The first version back in 2013 was based on crude counting and was more like a potential field. (Btw, it was in <a target="_blank" class="text-link " href="https://en.wikipedia.org/wiki/Adobe_Flash">Flash</a>.) The Markov chain concept that I learned (2023) helped me make the calculations more accurate and the numbers more realistic.</span></p>
            <h2 id="observer-effect">Observer effect</h2>
            <p>Suppose a guard did come to investigate the nearest highest probability node (the doorway <em>D</em>). Coming from the south, the guard just saw the doorway and the immediate hallway in their field of vision - There are two possibilities: Either <strong>(1)</strong> they saw nothing, or <strong>(2)</strong> they saw <em>the target</em>.</p>
            <p>In case <strong>(1)</strong> where the guard saw nothing, we need to update the seen nodes according to the guard’s a posteriori observation.</p>
            <div class="small-diagram-row small-diagram-row-solo">
              <div class="blog-media blog-media-default">
                <img srcset="/notes/dynamic-patrol-stealth-games/observe-none_300.generated.png 300w" sizes=" 300px" class="blog-media-element" alt="Node graph with observed nodes having 0.0" src="/notes/dynamic-patrol-stealth-games/observe-none.png" spec="300" loading="lazy" width="100%" height="" style="aspect-ratio: 0.9705882352941176; background: #e8e8e8"><span class="blog-media-caption">After observation</span>
              </div>
            </div>

            <p>The nodes that were seen having no target at their locations are forced to a probability of <strong>0.0</strong>, because if you think about it, that makes sense. The remaining nodes are then scaled so that they still add up to a total of <strong>1.0</strong> (This is an invariant in any case).</p>
            <p>To illustrate, here’s a table that details each intermediate step:</p>
            <div class="probability-table">

              <div class="markdown-table">
                <table>
                  <thead>
                    <tr>
                      <th>Node</th>
                      <th>Prior<br>probabilities</th>
                      <th>Values after<br>observation</th>
                      <th>Final values<br>after rescaling</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>R</td>
                      <td>0.35</td>
                      <td>0.35</td>
                      <td><strong>0.9</strong></td>
                    </tr>
                    <tr>
                      <td>D</td>
                      <td>0.39</td>
                      <td><strong>0</strong></td>
                      <td>0</td>
                    </tr>
                    <tr>
                      <td>H0</td>
                      <td>0.04</td>
                      <td>0.04</td>
                      <td><strong>0.1</strong></td>
                    </tr>
                    <tr>
                      <td>H1</td>
                      <td>0.18</td>
                      <td><strong>0</strong></td>
                      <td>0</td>
                    </tr>
                    <tr>
                      <td>H2</td>
                      <td>0.04</td>
                      <td><strong>0</strong></td>
                      <td>0</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>



            <p>After updating the probabilities, the state of the graph tells us that the target is around 90% likely to be in the room <em>R</em> and 10% in the far hallway <em>H0</em>.</p>
            <p>The game AI can simply send the guard to the highest node based on the updated probabilities (this case, the room <em>R</em>). It can do this again and again, which will result in a seemingly organic and responsive searching behaviour from the AI guard. No predefined patrol routes needed.</p>
            <p><span class="box-note ">Another way to go about this is to keep track of probabilities in the form of rational numbers - separately tracking the numerators and the denominators. You only need to store the numerator per node, while there is one global denominator, which is the sum of all the numerators. This is what I did for my demo implementation.</span></p>
            <hr>
            <p>In case <strong>(2)</strong> where the guard saw the target, a similar but more drastic approach applies. The node containing the target is assigned <strong>1.0</strong> while <em>the rest of the nodes in the whole graph</em> are cleared back to <strong>0.0</strong>. The target can only be in one place at at a time!</p>
            <div class="small-diagram-row small-diagram-row-solo">
              <div class="blog-media blog-media-default">
                <img srcset="/notes/dynamic-patrol-stealth-games/observe-target_300.generated.png 300w" sizes=" 300px" class="blog-media-element" alt="Node graph with observed target in node having 1.0" src="/notes/dynamic-patrol-stealth-games/observe-target.png" spec="300" loading="lazy" width="100%" height="" style="aspect-ratio: 0.9705882352941176; background: #e8e8e8"><span class="blog-media-caption">After observation of target</span>
              </div>
            </div>

            <p>It stays that way as long as the guard can see the target. When the guard loses sight of the target again, we just continue the Markov inference and the probability values will spread again like a wave. The cycle of chasing, investigation, and hiding continues.</p>
            <span class="box-note ">
              Similar to quantum mechanics, an act of observation collapses the superposition. There seems to be an underlying mathematical truth that spans across Markov chains, quantum mechanics, Bayesian networks, and video game mechanics. :P
            </span>

            <p>It’s best to just see it in action. Play with the demo in the following section.</p>
            <h2 id="demo">Demo</h2>
            <p>I implemented this algorithm in JavaScript so you can play with it right here. In this implementation, the world is a 2D grid where each tile is a node in the Markov graph.</p>
            <p>Click a tile to command the target (the green character <img src="demo/target.png" alt="">) to move. A blue fog will indicate the probabilities of each tile.</p>
            <p>Have fun playing hide and seek!</p>
            <p><dynamic-patrol-demo-client tabindex="0" data-rss="interactive" aria-label="interactive demo of the dynamic patrol algorithm" map="
        ....................
        ....................
        .T##########.#####..
        ..#........#..#..#..
        ..#........#..#..#..
        ...........#..#..#..
        ..#........#####.#..
        ..#..............#..
        ..################..
        .G#........#........
        ###........#.....#..
        ..#######.########..
        ..#....#.........#..
        ..#....#.........#..
        ..#.........###..#..
        ..#....#.........#..
        ..#....#.........#..
        ..##.#############..
        ....................
        ....................
      "></dynamic-patrol-demo-client></p>
            <p><span class="box-note "><strong>Tip:</strong> Press <code>P</code> to toggle visibility of the probability field. Press <code>N</code> to toggle numbers between none, percentage, and log-scale. (Keyboard only)</span></p>
            <h2 id="conclusions">Conclusions</h2>
            <ul>
              <li>Emergent behaviours can be described:<ul>
                  <li>Chasing: Upon losing vision, the guard starts chasing in the direction where you ran away (without the guard actually seeing where you are).</li>
                  <li>Searching: As the chase continues, the path begins branching, and the probability dilutes. The guard gradually transitions from chasing behaviour to a searching behaviour.</li>
                  <li>Patrolling: As the probability distribution approaches equilibrium, the guard devolves into a plain patrol.</li>
                  <li>There is a spectrum from chasing to patrolling.</li>
                </ul>
              </li>
              <li>The probability spreading process can be drastically sped-up by implementing Markov chain transitions using matrix multiplication with a transition matrix.<ul>
                  <li>Matrix multiplication is <a target="_blank" class="text-link " href="https://en.wikipedia.org/wiki/Embarrassingly_parallel">embarrasingly parallel</a>.</li>
                </ul>
              </li>
              <li>The search route quality can be improved significantly. Currently it just sets the tile with the highest potential as the destination with an A* pathfinder, resetting the process whenever the tile becomes invalid.<ul>
                  <li>One improvement might involve incorporating the potential field as weights in the pathfinding algorithm itself to generate a more efficient and sweeping route.</li>
                </ul>
              </li>
            </ul>
            <p>Sadly, the name <a target="_blank" class="text-link " href="https://github.com/mxgmn/WaveFunctionCollapse">“Wave Function Collapse”</a> has already been claimed by a different video game algorithm, so I can’t give this one a cool quantum name anymore.</p>
            <hr>
            <p><strong>Bonus demo! 2 guards.</strong></p>
            <p><dynamic-patrol-demo-client tabindex="0" data-rss="interactive" aria-label="interactive demo of the dynamic patrol algorithm" map="
        .................#..
        .T...............#..
        ..#..####..#######..
        ..#.....#...........
        ..#.....#...........
        ..#..#..#######..###
        ...G.#..#........#..
        .....#..#........#..
        ######..####..####..
        ..#........#........
        ..#.G......#........
        ..#..#######..####..
        ..............#.....
        ..............#.....
        ######..#######..###
        ..#.....#........#..
        ..#.....#........#..
        ..#..#..####..#..#..
        .....#........#.....
        .....#........#.....
      "></dynamic-patrol-demo-client></p>
            <p>Special thanks:</p>
            <ul>
              <li><img src="demo/target.png" alt=""> Ally Gator as “The Target”</li>
              <li><img src="demo/guard.png" alt=""> Metal Head as “Guard 1”</li>
              <li><img src="demo/guard.png" alt=""> Rust Bucket as “Guard 2”</li>
              <li><a target="_blank" class="text-link " href="https://bitbucket.org/umbraprojekt/mrpas">bitbucket/umbraprojekt/mrpas</a> for guards’ vision <img src="demo/guard.png" alt="">🪧<img src="demo/guard.png" alt=""></li>
              <li><a target="_blank" class="text-link " href="https://github.com/qiao/PathFinding.js">github/qiao/PathFinding.js</a> for giving directions 🧭</li>
            </ul>
            <p><strong>Update:</strong> Related stuff I found:</p>
            <ul>
              <li><a target="_blank" class="text-link " href="https://youtu.be/eFP0_rkjwlY?t=842">Predicting Pac-Man ghosts with Markov chains [YouTube]</a>
                <ul>
                  <li>As mentioned above, I had a crude counting-based solution before, but the concept of Markov chains made it more accurate. This video is where I got the idea of applying Markov chains to a grid.</li>
                </ul>
              </li>
              <li><a target="_blank" class="text-link " href="https://ojs.aaai.org/index.php/AIIDE/article/download/7425/7308/10903">Dynamic Guard Patrol in Stealth Games [academic, PDF]</a>
                <ul>
                  <li>Accompanying video: <a target="_blank" class="text-link " href="https://youtu.be/9FyaMM7l2EU">YouTube</a></li>
                  <li>I found this after writing this post. The paper uses a similar potential field idea, but only tracks <em>staleness</em>. It behaves similarly to the Markov chain’s equilibrium state, but it cannot produce chasing behaviours.</li>
                </ul>
              </li>
            </ul>

          </div>

        </div>
        <div class="postcontent">
          <aside class="reactions">
            <h2 class="reaction-title">React to this post</h2>
            <button class="reaction-btn reaction-heart-btn">
              <span class="reaction-icon" aria-label="Heart"></span>
            </button>
            <div class="reaction-count reaction-heart-count"></div>
            <button class="reaction-btn reaction-fire-btn">
              <span class="reaction-icon" aria-label="Fire"></span>
            </button>
            <div class="reaction-count reaction-fire-count"></div>
            <button class="reaction-btn reaction-bubble-btn">
              <span class="reaction-icon" aria-label="Bubble"></span>
            </button>
            <div class="reaction-count reaction-bubble-count"></div>
            <button class="reaction-btn reaction-sun-btn">
              <span class="reaction-icon" aria-label="Sun"></span>
            </button>
            <div class="reaction-count reaction-sun-count"></div>
            <button class="reaction-btn reaction-cloud-btn">
              <span class="reaction-icon" aria-label="Cloud"></span>
            </button>
            <div class="reaction-count reaction-cloud-count"></div>
          </aside>
        </div>
      </div>

    </div>
    <footer class="main-footer">
      <div class="main-footer-content-part">
        <p class="main-footer-line">
          <a target="_self" class="main-footer-link" href="/">Home</a> ·
          <a target="_self" class="main-footer-link" href="/wares/">Software</a> ·
          <a target="_self" class="main-footer-link" href="/art/">Art</a> ·
          <a target="_self" class="main-footer-link" href="/notes/">Notes</a> ·
          <a target="_self" class="main-footer-link" href="/misc/">Misc</a>
        </p>
        <p class="main-footer-line">
          <img class="main-footer-signature" alt="" src="/icons/laptop_user.png" loading="lazy">
          ·
          <a target="_self" class="main-footer-link" href="/guestbook/">Sign my guestbook</a>
        </p>
        <p class="main-footer-line">
          (C) 2023 Lean Rada.
          <a target="_blank" class="main-footer-link" href="https://github.com/Kalabasa/kalabasa.github.io">
            Source
          </a>
        </p>
      </div>
      <div class="main-footer-content-part">
        <h2 class="main-footer-links-heading">On the web</h2>
        <a target="_blank" class="main-footer-web-link" href="https://www.linkedin.com/in/leanrada/">
          <img class="main-footer-web-link-icon" alt="LinkedIn" src="/icons/linkedin.png" loading="lazy">
        </a>
        <a target="_blank" class="main-footer-web-link" href="https://codepen.io/kalabasa">
          <img class="main-footer-web-link-icon" alt="CodePen" src="/icons/codepen.png" loading="lazy">
        </a>
        <a target="_blank" class="main-footer-web-link" href="https://stackoverflow.com/users/3144156/kalabasa">
          <img class="main-footer-web-link-icon" alt="Stack Overflow" src="/icons/stackoverflow.png" loading="lazy">
        </a>
        <a target="_blank" class="main-footer-web-link" href="https://github.com/Kalabasa" rel="me">
          <img class="main-footer-web-link-icon" alt="GitHub" src="/icons/github.png" loading="lazy">
        </a>
        <h2 class="main-footer-links-heading">Webrings</h2>
        <p class="main-footer-line">
          <img class="main-footer-webring-icon" alt="" src="/icons/planet.png" loading="lazy">
          <a target="_blank" class="main-footer-link" href="http://geekring.net/">geekring.net</a>
          [<a target="_blank" class="main-footer-link" href="http://geekring.net/site/288/previous" aria-label="Previous site">←</a>
          <a target="_blank" class="main-footer-link" href="http://geekring.net/site/288/random" aria-label="Random site">⁙</a>
          <a target="_blank" class="main-footer-link" href="http://geekring.net/site/288/next" aria-label="Next site">→</a>
          <a target="_blank" class="main-footer-link" href="http://geekring.net/site/288/frameset" aria-label="Frameset browsing">▣</a>]
        </p>
        <p class="main-footer-line">
          <img class="main-footer-webring-icon" alt="" src="/icons/planet.png" loading="lazy">
          <a target="_blank" class="main-footer-link" href="https://cs.sjoy.lol/">CSS JOY</a>
          [<a target="_blank" class="main-footer-link" href="https://webri.ng/webring/cssjoy/previous?via=https%3A%2F%2Fleanrada.com" aria-label="Previous site">←</a>
          <a target="_blank" class="main-footer-link" href="https://webri.ng/webring/cssjoy/random?via=https%3A%2F%2Fleanrada.com" aria-label="Random site">⁙</a>
          <a target="_blank" class="main-footer-link" href="https://webri.ng/webring/cssjoy/next?via=https%3A%2F%2Fleanrada.com" aria-label="Next site">→</a>]
        </p>
      </div>
      <nebula-client class="main-footer-nebula" palette="#0ad591 #ff2b75 #ffb833 #0ad591 #0ad591 #4d4aff #0ad591" width="40" height="10">
        <canvas style="filter: contrast(1.5)"></canvas>
        <div class="nebula-noise"></div>
      </nebula-client>
      <a class="main-footer-top-btn" href="#top" aria-label="Back to top">^</a>
    </footer>
  </div>


  <script type="module" async="" defer="" src="/scripts/reactions.js"></script>
  <script type="module" async="" defer="" src="/scripts/dynamic-patrol-demo.js"></script>
  <script defer="" src="/scripts/blog-media.js"></script>
  <script defer="" src="/scripts/blog-header.js"></script>
  <script type="module" async="" defer="" src="/scripts/nebula.js"></script>
  <script defer="" src="/scripts/main-footer-main-header.js"></script>
</body>
</html>