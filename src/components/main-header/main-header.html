<header class="{renderClass()}">
  <div class="main-header-bar">
    {renderItem('/', 'Home')}
    {renderItem('/wares/', 'Wares')}
    <img class="main-header-icon" src="/icons/tadaw_sheet.png" />
    {renderItem('/art/', 'Art')}
    {renderItem('/blog/', 'Blog')}
    <div class="main-header-indicator"></div>
  </div>
</header>

<script static>
  function renderClass() {
    return (
      "main-header" +
      (attrs.float ? " float" : "") +
      (attrs.prehide ? " prehide" : "")
    );
  }

  function renderItem(href, label) {
    return html`<a href="${href}" class="${renderItemClass(href)}"
      >${label}</a
    >`;
  }

  function renderItemClass(href) {
    return "main-header-item " + (attrs.select === href ? "select" : "");
  }
</script>

<style>
  .main-header {
    position: sticky;
    top: 0;
    width: 100%;
    height: 60px;
    padding: 0 calc(25% - 150px);
    z-index: 100;
    box-sizing: border-box;
    pointer-events: none;
  }
  .main-header.float {
    position: fixed;
  }

  .main-header-bar {
    position: relative;
    display: flex;
    justify-content: space-evenly;
    align-items: flex-end;
    height: 100%;
  }

  .main-header-item {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 6ch;
    height: 36px;
    padding: 0 18px;
    border-radius: 18px;
    font-size: 15px;
    font-weight: bold;
    letter-spacing: 1px;
    text-decoration: none;
    text-transform: uppercase;
    color: #fff;
    backdrop-filter: blur(8px);
    background-image: linear-gradient(60deg, #fff2 60%, transparent 60%);
    background-repeat: no-repeat;
    background-size: 220% 100%;
    background-position: 115%;
    pointer-events: all;
    transition: background-position 0.2s var(--ease);
  }
  .main-header-item:hover {
    background-image: linear-gradient(
      60deg,
      #fff2 50%,
      #fff 50%,
      #fff 60%,
      transparent 60%
    );
    background-position: 0%;
  }
  .main-header-item.select {
    background: #fff2;
  }

  .main-header-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    image-rendering: pixelated;
    object-fit: cover;
    object-position: center left;
    filter: invert(1);
    backdrop-filter: blur(8px) invert(1);
    pointer-events: all;
  }
  .main-header-icon:hover {
    object-position: center right;
  }
  @media (max-width: 450px) {
    .main-header-icon {
      display: none;
    }
  }

  .main-header-indicator {
    position: absolute;
    width: 6px;
    height: 6px;
    left: 50%;
    top: calc(100% + 12px);
    transform: translate(-50%, -50%);
    /* border acts as extended touch area */
    border: solid 6mm transparent;
    border-left-width: 45vw;
    border-right-width: 45vw;
    border-radius: 50%;
    background: #fff;
    background-clip: padding-box;
    opacity: 0;
    transition: opacity 50ms;
  }
  .main-header.hidden .main-header-indicator {
    opacity: 0.8;
    pointer-events: all;
  }
</style>

<script client defer>
  (() => {
    const mainHeader = document.querySelector(".main-header");
    const indicator = document.querySelector(".main-header-indicator");

    let currentY = 0;
    let currentYTarget = 0;

    let mouseHovering = false;

    let isTouch = false;
    let lastScrollY = window.scrollY;
    let lastCursorY = 0;
    window.addEventListener("scroll", debounce(onScroll));
    window.addEventListener("mousemove", debounce(onMouseMove, 100));
    window.addEventListener("touchstart", onWindowTouchStart);
    window.addEventListener("touchmove", onWindowTouchMove);
    mainHeader.addEventListener("touchstart", onTouchStart);

    function onScroll(event) {
      const dy = window.scrollY - lastScrollY;

      // move with the page
      currentY -= dy;
      if (currentY > 0) {
        currentY = 0;
      } else if (currentY < -mainHeader.offsetHeight) {
        currentY = -mainHeader.offsetHeight;
      }

      currentYTarget = currentY;
      updateDOM();

      lastScrollY = window.scrollY;
    }

    function onMouseMove(event) {
      if (isTouch) return;

      const dy = event.clientY - lastCursorY;

      // show when mouse goes near the top
      const scaledDy = Math.sign(dy) * Math.log1p(Math.abs(dy)) * 20;
      if (dy < 0 && event.clientY + scaledDy < mainHeader.offsetHeight) {
        currentYTarget = 0;
        mouseHovering = true;
      } else if (
        mouseHovering &&
        dy > 0 &&
        event.clientY > mainHeader.offsetHeight * 4
      ) {
        currentYTarget = Math.max(-window.scrollY, -mainHeader.offsetHeight);
        mouseHovering = false;
      }

      updateDOM();
      lastCursorY = event.clientY;
    }

    function onWindowTouchStart(event) {
      isTouch = true;
      lastCursorY = event.touches[0].clientY;
    }
    function onWindowTouchMove(event) {
      const dy = event.touches[0].clientY - lastCursorY;

      // move with touch but only if at edge
      if (window.scrollY <= 0 && dy > 0) {
        currentY += dy;
        if (currentY >= 0) {
          currentY = 0;
          document.body.style.overscrollBehaviorY = null;
        } else if (currentY < 0) {
          document.body.style.overscrollBehaviorY = "none";
        }

        currentYTarget = currentY;
        updateDOM();
      }

      lastCursorY = event.touches[0].clientY;
    }

    function onTouchStart(event) {
      currentYTarget = 0;
      updateDOM();
      console.log("onTouchStart");
    }

    const updateDOM = debounce(() => {
      mainHeader.style.transform = `translateY(${currentY.toFixed(2)}px)`;

      const isHidden = currentY < -mainHeader.offsetHeight * 0.8;
      mainHeader.classList.toggle("hidden", isHidden);

      if (Math.abs(currentY - currentYTarget) > 1) {
        currentY += (currentYTarget - currentY) * 0.2;
        requestAnimationFrame(updateDOM);
      } else {
        currentY = currentYTarget;
      }
    });

    if (mainHeader.classList.contains("prehide")) {
      document.body.style.overscrollBehaviorY = "none";
      currentY = currentYTarget = -mainHeader.offsetHeight;
      updateDOM();
    }

    function debounce(fn, ms = 0) {
      let recentlyFired = false;
      return (...args) => {
        if (recentlyFired) return;
        recentlyFired = true;
        if (ms === 0) {
          requestAnimationFrame(() => (recentlyFired = false));
        } else {
          setTimeout(() => (recentlyFired = false), ms);
        }
        return fn(...args);
      };
    }
  })();
</script>
