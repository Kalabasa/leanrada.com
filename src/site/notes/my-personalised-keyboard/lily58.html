<div class="lily58" data-rss="interactive" :aria-label="altText()">
  <div class="lily58-half-container">
    <div
      :class="'lily58-half lily58-left-half ' + halfClass(0)"
      aria-hidden="true"
    >
      <div class="lily58-grid">
        {kbd(0,0, "lily58-accent")} {kbd(0,1)} {kbd(0,2)} {kbd(0,3)} {kbd(0,4)}
        {kbd(0,5)} {kbd(1,0)} {kbd(1,1)} {kbd(1,2)} {kbd(1,3)} {kbd(1,4)}
        {kbd(1,5)} {kbd(2,0, "lily58-shade")} {kbd(2,1)} {kbd(2,2)} {kbd(2,3)}
        {kbd(2,4)} {kbd(2,5)} {kbd(3,0)} {kbd(3,1)} {kbd(3,2)} {kbd(3,3)}
        {kbd(3,4)} {kbd(3,5)}
      </div>
      {kbd(4,0, "lily58-x0 lily58-shade")} {kbd(4,1, "lily58-x1 lily58-shade")}
      {kbd(4,2, "lily58-x2 lily58-shade")} {kbd(4,3, "lily58-x3 lily58-shade")}
      {kbd(4,4, "lily58-x4 lily58-shade")}
      <div class="lily58-oled">{renderLeftOLED()}</div>
    </div>
    <slot name="left" />
  </div>
  <div class="lily58-half-container">
    <div
      :class="'lily58-half lily58-right-half ' + halfClass(1)"
      aria-hidden="true"
    >
      <div class="lily58-grid">
        {kbd(5,0)} {kbd(5,1)} {kbd(5,2)} {kbd(5,3)} {kbd(5,4)} {kbd(5,5,
        "lily58-shade")} {kbd(6,0)} {kbd(6,1)} {kbd(6,2)} {kbd(6,3)} {kbd(6,4)}
        {kbd(6,5)} {kbd(7,0)} {kbd(7,1)} {kbd(7,2)} {kbd(7,3)} {kbd(7,4)}
        {kbd(7,5, "lily58-accent")} {kbd(8,0)} {kbd(8,1)} {kbd(8,2)} {kbd(8,3)}
        {kbd(8,4)} {kbd(8,5)}
      </div>
      {kbd(9,0, "lily58-x0 lily58-shade")} {kbd(9,1, "lily58-x1 lily58-shade")}
      {kbd(9,2, "lily58-x2 lily58-shade")} {kbd(9,3, "lily58-x3 lily58-shade")}
      {kbd(9,4, "lily58-x4 lily58-shade")}
      <div class="lily58-oled">{renderRightOLED()}</div>
    </div>
    <slot name="right" />
  </div>
  <slot name="default" />
</div>

<style>
  .lily58 {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    column-gap: 60px;
    row-gap: 30px;
    font-family: var(--default-font, monospace);
    font-size: 15px;
  }
  .lily58 kbd {
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 6px;
    width: 30px;
    height: 30px;
    line-height: 1;
    background: white;
    color: black;
  }
  kbd.lily58-accent {
    background: #72cbe9;
  }
  kbd.lily58-shade {
    background: #bed4e5;
  }
  .lily58-no-layers kbd.lily58-nofocus,
  .lily58-on-layer0 kbd.lily58-nofocus,
  kbd:empty,
  .lily58-on-layer0 kbd:has(.lily58-layer0:empty),
  .lily58-on-layer1 kbd:has(.lily58-layer1:empty) {
    background: #787d80;
    color: #0006;
  }
  .lily58-half-container {
    display: inline-block;
  }
  .lily58-half {
    position: relative;
    width: 246px;
    height: 187px;
    filter: drop-shadow(0 4px 0 #4c5858);
  }
  .lily58-half-unfocused {
    opacity: 0.6;
    /* height: 0;
    overflow: none;
    visibility: hidden; */
  }
  .lily58-left-half .lily58-grid > kbd:nth-child(6n + 1),
  .lily58-right-half .lily58-grid > kbd:nth-child(6n) {
    position: relative;
    top: 10px;
  }
  .lily58-left-half .lily58-grid > kbd:nth-child(6n + 2),
  .lily58-right-half .lily58-grid > kbd:nth-child(6n + 5) {
    position: relative;
    top: 8px;
  }
  .lily58-left-half .lily58-grid > kbd:nth-child(6n + 3),
  .lily58-right-half .lily58-grid > kbd:nth-child(6n + 4) {
    position: relative;
    top: 2px;
  }
  .lily58-left-half .lily58-grid > kbd:nth-child(6n + 5),
  .lily58-right-half .lily58-grid > kbd:nth-child(6n + 2) {
    position: relative;
    top: 2px;
  }
  .lily58-left-half .lily58-grid > kbd:nth-child(6n),
  .lily58-right-half .lily58-grid > kbd:nth-child(6n + 1) {
    position: relative;
    top: 4px;
  }
  .lily58-grid {
    display: grid;
    gap: 6px;
    grid-template-columns: repeat(6, min-content);
    grid-template-rows: repeat(4, min-content);
  }
  .lily58-right-half .lily58-grid {
    position: relative;
    left: 36px;
  }
  .lily58-left-half .lily58-x0 {
    position: absolute;
    left: 90px;
    top: 146px;
  }
  .lily58-left-half .lily58-x1 {
    position: absolute;
    left: 126px;
    top: 146px;
  }
  .lily58-left-half .lily58-x2 {
    position: absolute;
    left: 162px;
    top: 146px;
  }
  .lily58-left-half .lily58-x3 {
    position: absolute;
    left: 208px;
    top: 140px;
    transform: rotate(30deg);
    height: 45px;
  }
  .lily58-left-half .lily58-x4 {
    position: absolute;
    left: 216px;
    top: 90px;
  }
  .lily58-right-half .lily58-x4 {
    position: absolute;
    right: 90px;
    top: 146px;
  }
  .lily58-right-half .lily58-x3 {
    position: absolute;
    right: 126px;
    top: 146px;
  }
  .lily58-right-half .lily58-x2 {
    position: absolute;
    right: 162px;
    top: 146px;
  }
  .lily58-right-half .lily58-x1 {
    position: absolute;
    right: 208px;
    top: 140px;
    transform: rotate(-30deg);
    height: 45px;
  }
  .lily58-right-half .lily58-x0 {
    position: absolute;
    right: 216px;
    top: 90px;
  }
  .lily58-oled {
    position: absolute;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 30px;
    height: 64px;
    background: black;
    border: solid 1px #222;
  }
  .lily58-no-layers .lily58-oled:has(img),
  .lily58-on-layer0 .lily58-oled:has(img) {
    border-image: linear-gradient(0, #222, #233 30%, #566, #233 70%, #222) 1;
  }
  .lily58-oled > img {
    width: 24px;
    height: 24px;
    object-fit: contain;
    image-rendering: pixelated;
    filter: drop-shadow(0 0 8px #cff5) drop-shadow(-4px 2px 1px #cff2)
      drop-shadow(4px -2px 1px #cff2);
  }
  .lily58-left-half .lily58-oled {
    left: 218px;
    top: 5px;
  }
  .lily58-right-half .lily58-oled {
    right: 218px;
    top: 5px;
  }
  .lily58-layer-button {
    position: relative;
    padding: 0;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    border: double 4px #0f0;
    border-radius: inherit;
    color: #0f0;
    background: #000c;
    font: inherit;
    line-height: inherit;
    cursor: pointer;
  }
  .lily58-layer-button:hover {
    background: #000a;
  }
  .lily58-layer1 .lily58-layer-button {
    filter: invert(1);
    background: #fffc;
  }
  .lily58-layer1 .lily58-layer-button:hover {
    background: #fffa;
  }
  /* larger touch target */
  .lily58-layer-button::after {
    content: "";
    position: absolute;
    inset: -5mm;
  }
  .lily58-layer0,
  .lily58-layer1,
  .lily58-text-size {
    display: inherit;
    justify-content: inherit;
    align-items: inherit;
    border-radius: inherit;
    width: 100%;
    height: 100%;
    line-height: inherit;
  }
  .lily58-layer1 {
    display: none;
  }
  .lily58-on-layer1 .lily58-layer1 {
    display: inherit;
  }
  .lily58-on-layer1 .lily58-layer0 {
    display: none;
  }
</style>

<script client defer async>
  (() => {
    const lilies = document.querySelectorAll(".lily58");
    for (const lily of lilies) {
      const layerButtons = lily.querySelectorAll(".lily58-layer-button");

      if (!layerButtons.length) {
        lily.classList.add("lily58-no-layers");
        continue;
      }

      let currentLayer = 0;
      lily.classList.add("lily58-on-layer" + currentLayer);
      const toggleLayer = () => {
        lily.classList.remove("lily58-on-layer" + currentLayer);
        currentLayer = 1 - currentLayer;
        lily.classList.add("lily58-on-layer" + currentLayer);
      };

      for (const layerButton of layerButtons) {
        layerButton.addEventListener("click", toggleLayer);
      }
    }
  })();
</script>

<script static>
  const { oledLeft, oledRight } = attrs;
  const keys = attrs.keys && JSON.parse(attrs.keys);
  const focusRects =
    attrs.focusRects && JSON.parse("[" + attrs.focusRects + "]");
  const layer = attrs.layer && JSON.parse(attrs.layer);
  const layerButton =
    attrs.layerButton && attrs.layerButton.split(",").map(Number);

  function halfClass(half) {
    if (focusRects) {
      // check if a focusRect intersects this half
      const [hx, hy, hw, hh] =
        half <= 0 ? /* left */ [0, 0, 6, 5] : /* right */ [0, 5, 6, 5];
      const intersects = focusRects.some(
        ([x, y, w, h]) =>
          x <= hx + hw && x + w >= hx && y <= hy + hh && y + h >= hy
      );
      if (!intersects) return "lily58-half-unfocused";
    }
    return "";
  }

  function kbd(row, col, className = "") {
    // prettier-ignore
    return html`<kbd class="${className} ${kbdClass(row, col)}">${kbdContent(row, col)}</kbd>`;
  }

  // renders kbd class
  function kbdClass(row, col) {
    if (focusRects) {
      return isFocused(row, col) ? "lily58-focus" : "lily58-nofocus";
    }
    return "";
  }

  function isFocused(row, col) {
    return (
      !focusRects ||
      focusRects.some(
        ([x, y, w, h]) => col >= x && col < x + w && row >= y && row < y + h
      )
    );
  }

  // renders kbd content
  function kbdContent(row, col) {
    const value = keys[row][col];
    const content = renderContent(value, row, col);

    if (layer) {
      const layerValue = layer[row][col];
      const layerContent = renderContent(layerValue, row, col);
      // prettier-ignore
      return html`<div class="lily58-layer0">${renderTextSize(value, content)}</div>
        <div class="lily58-layer1">${renderTextSize(layerValue, layerContent)}</div>`;
    } else {
      return renderTextSize(value, content);
    }
  }

  function renderContent(value, row, col) {
    const text = value.replace(
      /[\u00A0-\u9999<>\&]/g,
      (i) => "&#" + i.charCodeAt(0) + ";"
    );

    let content = text;
    if (layerButton && layerButton[0] === row && layerButton[1] === col) {
      content = html`<button class="lily58-layer-button">${content}</button>`;
    }

    return content;
  }

  function renderTextSize(value, content) {
    const length = Intl.Segmenter
      ? [...new Intl.Segmenter().segment(value)].length
      : [...value].length;

    const maxLengthForFullSizedText = 2;

    if (length <= maxLengthForFullSizedText) {
      return html`${content}`;
    } else {
      const size =
        50 + Math.floor(50 / (1 + length - maxLengthForFullSizedText));
      const weightRule = length > 3 ? "font-weight:bold;" : "";

      return html`<span
        class="lily58-text-size"
        style="font-size:${size}%;${weightRule}"
      >
        ${content}
      </span>`;
    }
  }

  function renderLeftOLED() {
    if (!oledLeft) return null;
    return html`<img alt="" class="lily58-layer0" src="${oledLeft}" />`;
  }

  function renderRightOLED() {
    if (!oledRight) return null;
    return html`<img alt="" class="lily58-layer0" src="${oledRight}" />`;
  }

  function altText() {
    const leftKeymap = renderAltKeymap(keys.slice(0, 5));
    const rightKeymap = renderAltKeymap(keys.slice(5, 10));
    return (
      "Lily58 keyboard layout diagram\n  Left hand:\n" +
      leftKeymap +
      "\n  Right hand:\n" +
      rightKeymap
    );
  }

  function renderAltKeymap(keys) {
    return keys
      .map(
        (rowKeys, row) =>
          "    " +
          rowKeys
            .map(
              (key, col) =>
                "[" + centerAltKey(isFocused(row, col) ? key : " ") + "]"
            )
            .join("")
      )
      .join("\n");
  }

  function centerAltKey(label) {
    const maxLength = 4;
    return (
      "".padStart(Math.floor((maxLength - label.length) / 2), " ") + label
    ).padEnd(maxLength, " ");
  }
</script>
